var leftPanel_Parents =
    [
        { id: 1, parent_name: "TABLE STRUCTURE", parent_id: "", DisplayName: "TABLE STRUCTURE", name_class: "", selections: "", hasChild: false, menuLevel: 0, isDefaultLevel: true, IsSelectable: false, isMulti: true, show: true, data: [] },
        { id: 2, parent_name: "COLUMN", parent_id: "", DisplayName: "COLUMN", name_class: "column", selections: "None", hasChild: true, menuLevel: 0, isDefaultLevel: true, IsSelectable: true, isMulti: true, show: true, data: [] },
        { id: 3, parent_name: "ROW", parent_id: "", DisplayName: "ROW", name_class: "rows", selections: "None", menuLevel: 0, hasChild: true, isDefaultLevel: true, IsSelectable: true, isMulti: true, show: true, data: [] },
        { id: 4, parent_name: "ROW NESTING", parent_id: "", DisplayName: "ROW NESTING", name_class: "rownesting", selections: "None", menuLevel: 0, hasChild: true, isDefaultLevel: true, IsSelectable: true, isMulti: true, show: true, data: [] },
        { id: 5, parent_name: "TABLE CONTENT", parent_id: "", DisplayName: "TABLE CONTENT", name_class: "", selections: "", hasChild: false, menuLevel: 0, isDefaultLevel: true, IsSelectable: false, isMulti: true, show: true, data: [] },
        { id: 6, parent_name: "TIME PERIOD", parent_id: "", DisplayName: "TIME PERIOD", name_class: "timeperiod", selections: "None", menuLevel: 0, hasChild: true, isDefaultLevel: true, IsSelectable: true, isMulti: true, show: true, data: [] },
        { id: 7, parent_name: "MARKETS", parent_id: "", DisplayName: "MARKETS", name_class: "markets", selections: "None", menuLevel: 0, hasChild: true, isDefaultLevel: true, IsSelectable: true, isMulti: true, show: true, data: [] },
        { id: 8, parent_name: "OCCASION", parent_id: "", DisplayName: "OCCASION", name_class: "occasion", selections: "None", menuLevel: 0, hasChild: true, isDefaultLevel: true, IsSelectable: true, isMulti: true, show: true, data: [], isGroupNeeded: true },
        { id: 9, parent_name: "CATEGORY/ITEM/BRAND", parent_id: "", DisplayName: "CATEGORY/ITEM/BRAND", name_class: "category", selections: "None", menuLevel: 0, hasChild: true, isDefaultLevel: true, IsSelectable: true, isMulti: true, show: true, data: [] },
        { id: 10, parent_name: "5Ws", parent_id: "", DisplayName: "5Ws", name_class: "ws", selections: "None", menuLevel: 0, hasChild: true, isDefaultLevel: true, IsSelectable: true, isMulti: true, show: true, data: [] },
        { id: 11, parent_name: "DEMOGRAPHICS", parent_id: "", DisplayName: "DEMOGRAPHICS", name_class: "demographics", selections: "None", hasChild: true, menuLevel: 0, isDefaultLevel: true, IsSelectable: true, isMulti: true, show: true, data: [] },
        { id: 12, parent_name: "ADDITIONAL FILTERS", parent_id: "", DisplayName: "ADDITIONAL FILTERS", name_class: "additionalfilters", selections: "None", hasChild: true, menuLevel: 0, isDefaultLevel: true, IsSelectable: true, isMulti: true, show: true, data: [] },
        { id: 13, parent_name: "BENCHMARK", parent_id: "", DisplayName: "BENCHMARK", name_class: "benchmark", selections: "None", menuLevel: 0, hasChild: true, isDefaultLevel: true, IsSelectable: true, isMulti: true, show: true, data: [], isDisabled: false }
    ]
var ColumnStaticData =
    [
    { "AttributeId": 1, "AttributetypeId": 1, "CountryID": 0, "DisplayName": "Occasion", "Filter": "COLUMN", "FilterID": 1, "IsLastLevel": true, "IsSelectable": true, "MetricName": "Occasion", "MetricParentName": "COLUMN", "ParentId": null, "SortID": 1, "data": [], "isDefaultLevel": false, "isSingle": true },
    {
        "AttributeId": 2, "AttributetypeId": 2, "CountryID": 0, "DisplayName": "Survey Category/Item/Brand", "Filter": "COLUMN", "FilterID": 2, "IsLastLevel": false, "IsSelectable": false, "MetricName": "Survey Category/Item/Brand", "MetricParentName": "COLUMN", "ParentId": null, "SortID": 2, "data": [{ "AttributeId": 1, "AttributetypeId": 1, "CountryID": 0, "DisplayName": "Category", "Filter": "Survey Category/Item/Brand", "FilterID": 1, "IsLastLevel": true, "IsSelectable": true, "MetricName": "Category", "MetricParentName": "Survey Category/Item/Brand", "ParentId": null, "SortID": 1, "data": [], "isDefaultLevel": false, "isSingle": true }, { "AttributeId": 2, "AttributetypeId": 2, "CountryID": 0, "DisplayName": "Item", "Filter": "Survey Category/Item/Brand", "FilterID": 2, "IsLastLevel": true, "IsSelectable": true, "MetricName": "Item", "MetricParentName": "Survey Category/Item/Brand", "ParentId": null, "SortID": 2, "data": [], "isDefaultLevel": false, "isSingle": true }, { "AttributeId": 3, "AttributetypeId": 3, "CountryID": 0, "DisplayName": "Brand", "Filter": "Survey Category/Item/Brand", "FilterID": 3, "IsLastLevel": true, "IsSelectable": true, "MetricName": "Brand", "MetricParentName": "Survey Category/Item/Brand", "ParentId": null, "SortID": 3, "data": [], "isDefaultLevel": false, "isSingle": true }, { "AttributeId": 4, "AttributetypeId": 4, "CountryID": 0, "DisplayName": "Category-Manufacturer", "Filter": "Survey Category/Item/Brand", "FilterID": 4, "IsLastLevel": true, "IsSelectable": true, "MetricName": "Category-Manufacturer", "MetricParentName": "Survey Category/Item/Brand", "ParentId": null, "SortID": 4, "data": [], "isDefaultLevel": false, "isSingle": true }, { "AttributeId": 5, "AttributetypeId": 5, "CountryID": 0, "DisplayName": "Item-Manufacturer", "Filter": "Survey Category/Item/Brand", "FilterID": 5, "IsLastLevel": true, "IsSelectable": true, "MetricName": "Item-Manufacturer", "MetricParentName": "Survey Category/Item/Brand", "ParentId": null, "SortID": 5, "data": [], "isDefaultLevel": false, "isSingle": true }], "isDefaultLevel": false, "isSingle": true
    },
    {
        "AttributeId": 3, "AttributetypeId": 3, "CountryID": 0, "DisplayName": "Custom Category/Item/Brand", "Filter": "COLUMN", "FilterID": 3, "IsLastLevel": false, "IsSelectable": false, "MetricName": "Custom Category/Item/Brand", "MetricParentName": "COLUMN", "ParentId": null, "SortID": 3, "data": [{ "AttributeId": 1, "AttributetypeId": 1, "CountryID": 0, "DisplayName": "Category", "Filter": "Custom Category/Item/Brand", "FilterID": 1, "IsLastLevel": true, "IsSelectable": true, "MetricName": "Category", "MetricParentName": "Custom Category/Item/Brand", "ParentId": null, "SortID": 1, "data": [], "isDefaultLevel": false, "isSingle": true }, { "AttributeId": 2, "AttributetypeId": 2, "CountryID": 0, "DisplayName": "Item", "Filter": "Custom Category/Item/Brand", "FilterID": 2, "IsLastLevel": true, "IsSelectable": true, "MetricName": "Item", "MetricParentName": "Custom Category/Item/Brand", "ParentId": null, "SortID": 2, "data": [], "isDefaultLevel": false, "isSingle": true }, { "AttributeId": 3, "AttributetypeId": 3, "CountryID": 0, "DisplayName": "Brand", "Filter": "Custom Category/Item/Brand", "FilterID": 3, "IsLastLevel": true, "IsSelectable": true, "MetricName": "Brand", "MetricParentName": "Custom Category/Item/Brand", "ParentId": null, "SortID": 3, "data": [], "isDefaultLevel": false, "isSingle": true }, { "AttributeId": 4, "AttributetypeId": 4, "CountryID": 0, "DisplayName": "Category-Manufacturer", "Filter": "Custom Category/Item/Brand", "FilterID": 4, "IsLastLevel": true, "IsSelectable": true, "MetricName": "Category-Manufacturer", "MetricParentName": "Custom Category/Item/Brand", "ParentId": null, "SortID": 4, "data": [], "isDefaultLevel": false, "isSingle": true }, { "AttributeId": 5, "AttributetypeId": 5, "CountryID": 0, "DisplayName": "Item-Manufacturer", "Filter": "Custom Category/Item/Brand", "FilterID": 5, "IsLastLevel": true, "IsSelectable": true, "MetricName": "Item-Manufacturer", "MetricParentName": "Custom Category/Item/Brand", "ParentId": null, "SortID": 5, "data": [], "isDefaultLevel": false, "isSingle": true }], "isDefaultLevel": false, "isSingle": true
    },
    { "AttributeId": 4, "AttributetypeId": 3, "CountryID": 0, "DisplayName": "5Ws", "Filter": "COLUMN", "FilterID": 3, "IsLastLevel": true, "IsSelectable": true, "MetricName": "5Ws", "MetricParentName": "COLUMN", "ParentId": null, "SortID": 3, "data": [], "isDefaultLevel": false, "isSingle": true },
    { "AttributeId": 5, "AttributetypeId": 4, "CountryID": 0, "DisplayName": "Demographics", "Filter": "COLUMN", "FilterID": 4, "IsLastLevel": true, "IsSelectable": true, "MetricName": "Demographics", "MetricParentName": "COLUMN", "ParentId": null, "SortID": 4, "data": [], "isDefaultLevel": false, "isSingle": true },
    { "AttributeId": 6, "AttributetypeId": 5, "CountryID": 0, "DisplayName": "Time Period", "Filter": "COLUMN", "FilterID": 5, "IsLastLevel": true, "IsSelectable": true, "MetricName": "Time Period", "MetricParentName": "COLUMN", "ParentId": null, "SortID": 5, "data": [], "isDefaultLevel": false, "isSingle": true },
    { "AttributeId": 7, "AttributetypeId": 6, "CountryID": 0, "DisplayName": "Market", "Filter": "COLUMN", "FilterID": 6, "IsLastLevel": true, "IsSelectable": true, "MetricName": "Market", "MetricParentName": "COLUMN", "ParentId": null, "SortID": 6, "data": [], "isDefaultLevel": false, "isSingle": true }
    ]

var MarketRegionList = [];
var selectedItems = [], LeftPanelOriginalData, scenarios, timeperiodList, CrossTabRequest = [], responseData = [], submitFlag = 0, exportFlag = 0;

$(window).resize(function () {
    if (responseData.length > 0) {
        if (angular.element(".tableChart.active").length > 0) {
            if (angular.element(document.getElementsByClassName("nsample-size_selected")).length > 0) {
                CreateGrid(angular.element(".samplesize-popup .popup-header div.active:visible").text().trim().split(" ")[0], $(".samplesize-popup .popup-container"));
            }
            else {
                CreateGrid("Percentage", $(".output-container .chartArea"))
            }
        }
        else
            selectChartType(undefined, angular.element(".trendChart.active").length > 1 ? 1 : 0)
    }
})
angular.module('starter.controllers', ["ngAnimate", 'commonService', "ui.bootstrap"])
    .controller('parent-controller', ["$scope", "$timeout", "$http", "commonService", "$compile", "$sce", function ($scope, $timeout, $http, commonService, $compile, $sce) {
        showBackgroundShadow(true, true);
        $scope.ModuleIsHidden = true;
        //$scope.showSettings = false;
        $scope.leftMenuIsHidden = true;
        $scope.parent_list = [];
        angular.element(document.querySelectorAll(".moduleLevel[title='VISUAL CROSSTAB']")).addClass("active");
        angular.element(document.querySelectorAll(".module-name .middleAlign")).text("Visual Crosstab");


        //add specific class for internet explorer
        if ((/*@cc_on!@*/false || !!document.documentMode)) {
            angular.element("body,html,form").addClass("ie11");
        }

        $scope.LeftStaticMenu = leftPanel_Parents;
        $http({
            method: callsType.Post,
            url: services.LoadLeftPanel,
            async: true,
            data: { "moduleId": selectedModuleId },
        }).then(function successCallback(response) {
            LeftPanelOriginalData = response.data.where(function (e) { return e.DisplayName });
            timeperiodList = response.data[response.data.length - 2];
            MarketRegionList = [];
            angular.forEach(LeftPanelOriginalData.filter(function (e) { return e.DisplayName == "Markets" })[0].data.filter(function (e) { return e.DisplayName.indexOf("Select All") == -1 }), function (a, b) {
                angular.forEach(a.data, function (c, d) {
                    MarketRegionList.push({ "DisplayName": c.DisplayName, "Region": a.DisplayName, "MarketId": c.CountryID, "FilterID": c.FilterID, "isDisabled": false })
                })
            })
            scenarios = response.data[response.data.length - 1];
            angular.element("#crosstab-container").html("");
        }, function (data) {
            show_popup("Error", data.statusText);
            showBackgroundShadow(false, false);
        });

        /*sample size click event start*/
        $scope.samplesizedetails = function ($event) {
            //$scope.showSettings = false;
            if (!$scope.leftMenuIsHidden)
                $scope.leftPanelToggle($event);
            if (!$scope.ModuleIsHidden)
                $scope.ModulePanelToggle($event);
            var activeSampleSize = "nsample-size_selected";
            if (!angular.element($event.currentTarget).hasClass(activeSampleSize)) {
                angular.element($event.currentTarget).addClass(activeSampleSize);
                angular.element(document.getElementsByClassName("samplesize-popup")).addClass("show_element");
                showBackgroundShadow(true, false);
            }
            else {
                angular.element($event.currentTarget).removeClass(activeSampleSize);
                angular.element(document.getElementsByClassName("samplesize-popup")).removeClass("show_element");
                showBackgroundShadow(false, false);
            }
            angular.element(document.querySelectorAll(".summaryPopup")).css("display", "none");
            angular.element(document.querySelectorAll(".summary-view-click")).removeClass("summaryPopup_selected");
            angular.element(document.getElementsByClassName("weightedOccasionDiv")).addClass("active");
            angular.element(document.getElementsByClassName("unweightedOccasionDiv")).removeClass("active");
            angular.element(".samplesize-popup .samplesizeHead .middleAlign").text("SAMPLE SIZE");
            CreateGrid("Weighted", $(".samplesize-popup .popup-container"));
        }
        /*sample size click event end*/

        loadCommonFunctionalities($scope, commonService, $http); //Common functionalities

        $scope.Exports = function (type) {
            if (!exportFlag) {
                show_popup("Alert", "Please click on submit and try again, as the selection has been changed.");
                return false;
            }
            myFunction1();
            showBackgroundShadow(true, true);
            var resp = JSON.stringify(responseData);
            $.ajax({
                url: services.CrosstabExport,
                data: "{'exportType': '" + type + "','requestData': '" + escape(JSON.stringify(CrossTabRequest)) + "' }",
                method: callsType.Post,
                contentType: "application/json",
                //processData: false,
                success: function (response) {
                    if (response != "Error") {
                        window.location.href = services.DownloadFile + encodeURIComponent(response);
                        showBackgroundShadow(false, false);
                    }
                    else {
                        show_popup("Alert", customMessages.Error);
                        return false;
                    }

                },
                error: function (xhr, status, error) {
                    show_popup("Alert", customMessages.Error);
                    return false;
                }
            });
        };

    }])
    .controller('Crosstab-Controller', ["$scope", "$timeout", "$http", "commonService", "$compile", "$sce", function ($scope, $timeout, $http, commonService, $compile, $sce) {

        $scope.customPopup['visible'] = false;
        $scope.crosstabLeftPanel = true;


        $scope.hideLeftPanel = function ($event) {
            if (!$scope.leftMenuIsHidden)
                $scope.leftPanelToggle($event);
            if (!$scope.ModuleIsHidden)
                $scope.ModulePanelToggle();
            //$scope.showSettings = false;
            angular.element(document.querySelectorAll(".summaryPopup")).css("display", "none");
            angular.element(document.querySelectorAll(".summary-view-click")).removeClass("summaryPopup_selected");


        }

        $scope.hideChartHelp = function ($event) {

            if ($event.hasClass("disableSelection")) {
                $("#chartCallout").toggle();
            }
        }
        $scope.numPages = function () {
            if ($scope.dataList != undefined && $scope.dataList.length > 0) {
                $scope.totalPages = Math.ceil($scope.dataList.length / $scope.numPerPage);
            }
            return $scope.totalPages;
        };
        $scope.setPage = function () {
            let pageNo = $("#go-to-box.user").val();
            if (pageNo <= Math.ceil($scope.dataList.length / $scope.numPerPage))
                $scope.currentPage = parseInt(pageNo);
        };
        $scope.$watch('currentPage + numPerPage', function () {
            $scope.userBegin = (($scope.currentPage - 1) * $scope.numPerPage), $scope.userEnd = $scope.userBegin + $scope.numPerPage;
            if ($scope.dataList != undefined && $scope.dataList.length > 0) {
                $scope.filteredColumnList = $scope.dataList.slice($scope.userBegin, $scope.userEnd);
                CreateGrid('Percentage', $(".output-container .chartArea"));
            }

        });
        $scope.setInitialValue = function () {
            $scope.currentPage = 1
            $scope.numPerPage = 20,
                $scope.maxSize = 5;
            $scope.totalPages = 1;
            $scope.dataList = angular.copy(responseData.filter(function (e) { return e.ColumnMetricName.toUpperCase() != "TOTAL" }).select("ColumnMetricName").distinct());
            $scope.filteredColumnList = $scope.dataList.slice(0, $scope.numPerPage);
            let paginationContainer = '<div class="containerFooter">' +
                '<div id="paginationContainer" class="user">' +
                '<div data-pagination="" data-num-pages="numPages()" data-current-page="currentPage" data-max-size="maxSize" data-boundary-links="true"></div>' +
                '<div id="go-to-container">' +
                '<div class="goToPage"><div class="middleAlign">Go to page</div></div>' +
                '<input id="go-to-box" class="user" type="number" min="1" value="1" max="{{totalPages}}" />' +
                '<div id="go-to-button" ng-click="setPage()">' +
                '<div id="go-to-text"><div class="middleAlign">Go</div></div>' +
                '<div class="goToIconDiv">' +
                '<div class="middleAlign"> >> </div>' +
                '</div>' +
                '</div>' +
                '</div>' +
                '</div>' +
                '</div>';
            angular.element(".output-container .containerFooter").detach();
            angular.element(".output-container").append($compile(paginationContainer)($scope));
        }

    }])
    .controller('LeftPanelController', ["$scope", "$timeout", "$http", "$filter", "commonService", "$compile", "$sce", function ($scope, $timeout, $http, $filter, commonService, $compile, $sce) {


        $scope.bindingLeftPanelDynamically = function (menusList, parentList) {
            let sObj = getSelectedMainValues();
            let selectedRowNesting = sObj.RowNesting, selectedRow = sObj.Row, selectedColumn = sObj.Column;
            //adding data to the left Panel
            if (menusList.DisplayName.toUpperCase() == "TIME PERIOD") {
                menusList.data = angular.copy($scope.bindTimePeriod(false));
            }
            else if (menusList.DisplayName.toUpperCase() == "OCCASION")
                menusList.data = angular.copy(LeftPanelOriginalData.filter(function (e) { return e.DisplayName.toUpperCase() == "OCCASION SEGMENTS" })[0].data);
            else if (menusList.DisplayName == "BENCHMARK") {
                menusList.data = angular.copy($scope.bindBenchmark());
            }
            else if (menusList.DisplayName.toUpperCase() == "CUSTOM FILTERS") {
                $scope.bindCustomFilters(menusList);
            }
            else if (menusList.DisplayName == "COLUMN" || menusList.DisplayName == "ROW" || menusList.DisplayName == "ROW NESTING" || menusList.DisplayName == "ADDITIONAL FILTERS") {
                if (menusList.DisplayName == "COLUMN" || menusList.DisplayName == "ROW" || menusList.DisplayName == "ROW NESTING")
                    menusList.data = angular.copy(ColumnStaticData);
                else
                    menusList.data = angular.copy(ColumnStaticData.filter(function (e) { return e.DisplayName != "Time Period" && e.DisplayName != "Market" }));
                applyToChild(menusList, ["Filter"], menusList.DisplayName);
                if (menusList.DisplayName == "ADDITIONAL FILTERS") {
                    let customFilters = { "AttributeId": 7, "AttributetypeId": 7, "CountryID": 0, "DisplayName": "Custom Filters", "Filter": "ADDITIONAL FILTERS", "FilterID": 7, "IsLastLevel": false, "IsSelectable": false, "MetricName": "Custom Filters", "MetricParentName": "ADDITIONAL FILTERS", "ParentId": null, "SortID": 8, "data": [], "isDefaultLevel": false, "isSingle": true };
                    let covid = { "AttributeId": 8, "AttributetypeId": 8, "CountryID": 0, "DisplayName": "COVID-19", "Filter": "ADDITIONAL FILTERS", "FilterID": 8, "IsLastLevel": false, "IsSelectable": false, "MetricName": "COVID-19", "MetricParentName": "ADDITIONAL FILTERS", "ParentId": null, "SortID": 7, "data": [], "isDefaultLevel": false, "isSingle": false };
                    menusList.data.push(covid);
                    menusList.data.push(customFilters);
                    $scope.addSampleType(menusList);
                    //let obj = getSelectedMainValues();
                    //let selectedRowNesting = obj.RowNesting, selectedRow = obj.Row, selectedColumn = obj.Column;
                    //let occasionList = menusList.data.filter(function (e) { return e.DisplayName == "Occasion" });
                    //occasionList[0].isDisabled = false;
                    //if (selectedColumn == "Occasion" || selectedRow == "Occasion" || selectedRowNesting == "Occasion")
                    //    occasionList[0].isDisabled = true;
                    //let catItemList = menusList.data.filter(function (e) { return e.DisplayName.indexOf("Category/Item/Brand") > -1 });
                    //catItemList[0].isDisabled = false;
                    //catItemList[0].data.filter(function (e) { return e.isDisabled = false });
                    //let selBucket = "";
                    //if (catList.indexOf(selectedColumn) > -1)
                    //    selBucket = $scope.getPKsAndName(selectedItems.filter(function (e) { return e.DisplayName == "COLUMN" })[0].Data, [])[0].Parent;
                    //if (catList.indexOf(selectedRow) > -1)
                    //    selBucket = $scope.getPKsAndName(selectedItems.filter(function (e) { return e.DisplayName == "ROW" })[0].Data, [])[0].Parent;
                    //if (catList.indexOf(selectedRowNesting) > -1)
                    //    selBucket = $scope.getPKsAndName(selectedItems.filter(function (e) { return e.DisplayName == "ROW NESTING" })[0].Data, [])[0].Parent;
                    //if (selBucket != "") {
                    //    let selBucketData = menusList.data.filter(function (e) { return e.DisplayName == selBucket })[0].data;
                    //    if (selectedColumn == "Category" || selectedRow == "Category" || selectedRowNesting == "Category") {
                    //        selBucketData.filter(function (e) { return e.DisplayName == "Category" })[0].isDisabled = true;
                    //    }
                    //    if (selectedColumn == "Item" || selectedRow == "Item" || selectedRowNesting == "Item") {
                    //        selBucketData.filter(function (e) { return e.DisplayName == "Category" })[0].isDisabled = true;
                    //        selBucketData.filter(function (e) { return e.DisplayName == "Item" })[0].isDisabled = true;
                    //    }
                    //    let list = ["Brand", "Category-Manufacturer", "Item-Manufacturer"]
                    //    if (list.indexOf(selectedColumn) > -1 || list.indexOf(selectedRow) > -1 || list.indexOf(selectedRowNesting) > -1) {
                    //        selBucketData.filter(function (e) { return e.DisplayName == "Category" })[0].isDisabled = true;
                    //        selBucketData.filter(function (e) { return e.DisplayName == "Item" })[0].isDisabled = true;
                    //        selBucketData.filter(function (e) { return e.DisplayName == "Brand" })[0].isDisabled = true;
                    //        //   if (menusList.data.filter(function (e) { return e.DisplayName == selBucket })[0].data.filter(function (e) { return e.DisplayName == "Category-Manufacturer" }).length > 0)
                    //        selBucketData.filter(function (e) { return e.DisplayName == "Category-Manufacturer" })[0].isDisabled = true;
                    //        //   if (menusList.data.filter(function (e) { return e.DisplayName == selBucket })[0].data.filter(function (e) { return e.DisplayName == "Item-Manufacturer" }).length > 0)
                    //        selBucketData.filter(function (e) { return e.DisplayName == "Item-Manufacturer" })[0].isDisabled = true;
                    //    }
                    //    if (selBucketData.filter(function (e) { return e.isDisabled }).length == selBucketData.length)
                    //        menusList.data.filter(function (e) { return e.DisplayName == selBucket })[0].isDisabled = true;
                    //    menusList.data.filter(function (e) { return e.DisplayName.indexOf("Category/Item/Brand") > -1 && e.DisplayName != selBucket })[0].isDisabled = true;
                    //}
                    angular.forEach(menusList.data.filter(function (e) { return e.DisplayName.indexOf("Category/Item/Brand") > -1 }), function (val, ind) {
                        val.data.filter(function (e) { return e.IsSelectable = false });
                        val.data.filter(function (e) { return e.IsLastLevel = false });
                    })
                    menusList.data.filter(function (e) { return e.IsSelectable = false });
                    menusList.data.filter(function (e) { return e.IsLastLevel = false })


                }
            }
            else if (menusList.DisplayName.toUpperCase().indexOf("CATEGORY/ITEM/BRAND") > -1 || (menusList.DisplayName.toUpperCase() == "CATEGORY" || menusList.DisplayName.toUpperCase() == "ITEM" || menusList.DisplayName.toUpperCase() == "BRAND" || menusList.DisplayName.toUpperCase() == "CATEGORY-MANUFACTURER" || menusList.DisplayName.toUpperCase() == "ITEM-MANUFACTURER") || ((menusList.DisplayName.toUpperCase() == "COLUMN" || menusList.DisplayName.toUpperCase() == "ROW" || menusList.DisplayName.toUpperCase() == "ROW NESTING") && parentList[0].DisplayName == "CATEGORY/ITEM/BRAND")) {

                let tempData = [], keepList = [];
                let appendText = "";
                let countryIds = $scope.returnCountryIds();
                if (!menusList.isDefaultLevel) {
                    let selBucket = "";
                    if (menusList.DisplayName.toUpperCase() == "COLUMN" && catList.indexOf(selectedColumn) > -1)
                        selBucket = $scope.getPKsAndName(selectedItems.filter(function (e) { return e.DisplayName == "COLUMN" })[0].Data, [])[0];
                    else if (menusList.DisplayName.toUpperCase() == "ROW" && catList.indexOf(selectedRow) > -1)
                        selBucket = $scope.getPKsAndName(selectedItems.filter(function (e) { return e.DisplayName == "ROW" })[0].Data, [])[0];
                    else if (menusList.DisplayName.toUpperCase() == "ROW NESTING" && catList.indexOf(selectedRowNesting) > -1)
                        selBucket = $scope.getPKsAndName(selectedItems.filter(function (e) { return e.DisplayName == "ROW NESTING" })[0].Data, [])[0];
                    appendText = (selBucket != "" && selBucket.Parent.indexOf("Custom") > -1) || parentList[1].DisplayName.indexOf("Custom") > -1 ? "CUSTOM " : "";
                    if (parentList[0].DisplayName == "ADDITIONAL FILTERS") {
                        appendText = parentList[1].DisplayName.split(' ')[0].toUpperCase();
                        appendText = appendText == "SURVEY" ? "" : "CUSTOM ";
                    }
                    if (menusList.DisplayName.toUpperCase() == "CATEGORY-MANUFACTURER" || menusList.DisplayName.toUpperCase() == "ITEM-MANUFACTURER" || (menusList.DisplayName.toUpperCase() == "COLUMN" && selectedColumn.toUpperCase().indexOf("MANUFACTURER") > -1) || (menusList.DisplayName.toUpperCase() == "ROW" && selectedRow.toUpperCase().indexOf("MANUFACTURER") > -1) || (menusList.DisplayName.toUpperCase() == "ROW NESTING" && selectedRowNesting.toUpperCase().indexOf("MANUFACTURER") > -1)) {
                        selBucket = "";
                        if (menusList.DisplayName.toUpperCase() == "COLUMN" && selectedColumn.toUpperCase().indexOf("MANUFACTURER") > -1)
                            selBucket = selectedColumn;
                        else if (menusList.DisplayName.toUpperCase() == "ROW" && selectedRow.toUpperCase().indexOf("MANUFACTURER") > -1)
                            selBucket = selectedRow;
                        else if (menusList.DisplayName.toUpperCase() == "ROW NESTING" && selectedRowNesting.toUpperCase().indexOf("MANUFACTURER") > -1)
                            selBucket = selectedRowNesting;
                        if (selBucket != "") {
                            tempData = angular.copy($scope.modifyMarketDependency(LeftPanelOriginalData.filter(function (e) { return e.DisplayName.toUpperCase() == "CATEGORY/ITEM-MANUFACTURER" })[0].data.filter(function (e) { return e.DisplayName.toUpperCase() == appendText + selBucket.toUpperCase() && (e.CountryID == 0 || countryIds.indexOf(e.CountryID) > -1) }), countryIds, menusList, parentList));
                        }
                        else {
                            tempData = angular.copy($scope.modifyMarketDependency(LeftPanelOriginalData.filter(function (e) { return e.DisplayName.toUpperCase() == "CATEGORY/ITEM-MANUFACTURER" })[0].data.filter(function (e) { return e.DisplayName.toUpperCase() == appendText + menusList.DisplayName.toUpperCase() && (e.CountryID == 0 || countryIds.indexOf(e.CountryID) > -1) }), countryIds, menusList, parentList));
                        }
                        if (countryIds.length > 1)
                            tempData = $scope.filterDups(tempData, countryIds.length);
                        tempData = tempData.filter(function (e) { return e.DisplayName == "Custom Group" }).concat(tempData.filter(function (e) { return e.DisplayName.toUpperCase() == appendText + selBucket.toUpperCase() || e.DisplayName.toUpperCase() == appendText + menusList.DisplayName.toUpperCase() })[0].data);
                    }
                    else {
                        tempData = angular.copy($scope.modifyMarketDependency(LeftPanelOriginalData.filter(function (e) { return e.DisplayName.toUpperCase() == appendText + menusList.DisplayName.toUpperCase() || (selBucket != "" && e.DisplayName.toUpperCase() == appendText + selBucket.DisplayName.toUpperCase()) })[0].data, countryIds, menusList, parentList));
                        if (countryIds.length > 1)
                            tempData = $scope.filterDups(tempData, countryIds.length);
                    }
                }
                if (menusList.isDefaultLevel) {
                    menusList.data = angular.copy(bindStaticList("Category/Item/Brand", parentList[0].DisplayName));
                }
                else if (menusList.DisplayName.toUpperCase() == "CATEGORY" || (menusList.DisplayName.toUpperCase() == "COLUMN" && selectedColumn == "Category") || (menusList.DisplayName.toUpperCase() == "ROW" && selectedRow == "Category") || (menusList.DisplayName.toUpperCase() == "ROW NESTING" && selectedRowNesting == "Category")) {
                    /*show selected categories*/
                    //tempData = tempData.filter(function (e) { return e.DisplayName.toUpperCase() != "SELECT ALL " + appendText + "BRANDS" && e.DisplayName.toUpperCase() != "SELECT ALL " + appendText + "ITEMS" && e.DisplayName.toUpperCase() != "SELECT ALL BRANDS" && e.DisplayName.toUpperCase() != "SELECT ALL ITEMS" });
                    if (selectedItems.filter(function (e) { return e.DisplayName == "CATEGORY/ITEM/BRAND" }).length > 0 && parentList[0].DisplayName != "ADDITIONAL FILTERS") {
                        if ((sessionStorage.getItem("widgetInfo") != null && sessionStorage.getItem("widgetInfo") != "")) {
                            let widgetInfo = JSON.parse(sessionStorage.getItem("widgetInfo"));
                            selectionObj = JSON.parse(widgetInfo.SelectionObj);
                            selectedItems = selectionObj.filter(function (e) { return e.DisplayName != "" });
                        }
                        else if (stickySelection.length > 0) {
                            selectedItems = stickySelection.filter(function (e) { return e.DisplayName != "" });
                        }
                        let catItemBrandList = selectedItems.filter(function (e) { return e.DisplayName == "CATEGORY/ITEM/BRAND" })[0].Data;
                        let columnList = catItemBrandList.filter(function (e) { return e.DisplayName == "Column" });
                        let rowList = catItemBrandList.filter(function (e) { return e.DisplayName == "Row" });
                        if (menusList.DisplayName.toUpperCase() != "COLUMN" && catList.indexOf(selectedColumn) > -1 && columnList.length > 0) {
                            keepList = $scope.filterList(columnList, keepList);
                        }
                        if (selectedColumn != "Category" && catList.indexOf(selectedColumn) > -1 && rowList.length > 0) {
                            keepList = $scope.filterList(rowList, keepList);
                        }
                        if (keepList.length > 0)
                            tempData = tempData.filter(function (e) { return keepList.indexOf(e.DisplayName) > -1 || e.DisplayName.toUpperCase() == "SELECT ALL " + appendText + "CATEGORIES" });
                    }
                    /*show selected categories*/
                    //angular.forEach(tempData.filter(function (e) { return e.DisplayName != "Custom Group" }), function (a, b) {
                    //    a.data = [];
                    //    a.IsSelectable = true;
                    //    a.IsLastLevel = true;
                    //})

                    menusList.data = tempData;
                }
                else if (menusList.DisplayName.toUpperCase() == "ITEM" || (menusList.DisplayName.toUpperCase() == "COLUMN" && selectedColumn == "Item") || (menusList.DisplayName.toUpperCase() == "ROW" && selectedRow == "Item") || (menusList.DisplayName.toUpperCase() == "ROW NESTING" && selectedRowNesting == "Item")) {
                    /*show selected categories*/
                    //let adnList = selectedItems.filter(function (e) { return e.DisplayName == "ADDITIONAL FILTERS" });
                    if (selectedItems.filter(function (e) { return e.DisplayName == "CATEGORY/ITEM/BRAND" }).length > 0 && parentList[0].DisplayName != "ADDITIONAL FILTERS") {
                        if ((sessionStorage.getItem("widgetInfo") != null && sessionStorage.getItem("widgetInfo") != "")) {
                            let widgetInfo = JSON.parse(sessionStorage.getItem("widgetInfo"));
                            selectionObj = JSON.parse(widgetInfo.SelectionObj);
                            selectedItems = selectionObj.filter(function (e) { return e.DisplayName != "" });
                        }
                        else if (stickySelection.length > 0) {
                            selectedItems = stickySelection.filter(function (e) { return e.DisplayName != "" });
                        }
                        let catItemBrandList = selectedItems.filter(function (e) { return e.DisplayName == "CATEGORY/ITEM/BRAND" })[0].Data;
                        let columnList = catItemBrandList.filter(function (e) { return e.DisplayName == "Column" });
                        let rowList = catItemBrandList.filter(function (e) { return e.DisplayName == "Row" });
                        if (menusList.DisplayName.toUpperCase() == "ROW NESTING") {
                            tempData = tempData.filter(value => ((rowList[0].Data.filter(e => e.FilterID == value.FilterID).length > 0) ||
                                value.DisplayName.toUpperCase() == "SELECT ALL " + appendText + "ITEMS" || value.DisplayName.toUpperCase() == "SELECT ALL ITEMS" || value.DisplayName.toUpperCase() == "CUSTOM GROUP"))
                        }
                        if (menusList.DisplayName.toUpperCase() != "COLUMN" && catList.indexOf(selectedColumn) > -1 && columnList.length > 0) {
                            keepList = $scope.filterList(columnList, keepList);
                        }

                        if (selectedColumn != "Item" && catList.indexOf(selectedColumn) > -1 && rowList.length > 0) {
                            keepList = $scope.filterList(rowList, keepList);
                        }
                        if (selectedColumn.indexOf("Category") == -1 && selectedRow.indexOf("Category") == -1 && selectedRowNesting.indexOf("Category") == -1 && parentList[0].DisplayName == "ADDITIONAL FILTERS") {
                            if (adnList.length > 0) {
                                let adnListData = adnList[0].Data.filter(function (e) { return e.DisplayName == "Category/Item/Brand" });
                                if (adnListData.length > 0)
                                    keepList = $scope.filterList(adnListData[0].Data.filter(function (e) { return e.DisplayName == "Category" }), keepList);
                            }
                        }
                    }
                    //let adnListData;
                    //if (adnList.length > 0) {
                    //    adnListData = adnList[0].Data.filter(function (e) { return e.DisplayName == parentList[1].DisplayName });
                    //    if (adnListData.length > 0 && parentList[0].DisplayName == "ADDITIONAL FILTERS") {
                    //        let categoryList = adnListData[0].Data.filter(function (e) { return e.DisplayName.indexOf("Category") > -1 });
                    //        if (categoryList.length > 0)
                    //            keepList = $scope.filterList(categoryList, keepList);
                    //    }
                    //}
                    if (keepList.length > 0)
                        tempData = tempData.filter(function (e) { return keepList.indexOf(e.DisplayName) > -1 || e.DisplayName.toUpperCase() == "SELECT ALL " + appendText + "ITEMS" || e.DisplayName.toUpperCase() == "SELECT ALL ITEMS" });
                    /*show selected categories*/
                    //tempData = tempData.filter(function (e) { return !e.IsLastLevel || e.DisplayName.toUpperCase() == "SELECT ALL " + appendText + "ITEMS" || e.DisplayName.toUpperCase() == "SELECT ALL ITEMS" });
                    //angular.forEach(tempData.filter(function (e) { return e.DisplayName != "Custom Group" }), function (a, b) {
                    //    if (a.DisplayName.indexOf("Select All") == -1) {
                    //        a.IsSelectable = false;
                    //        a.IsLastLevel = false;
                    //        /*add select all*/
                    //        let obj = {
                    //        };
                    //        obj.AttributeId = 0,
                    //            obj.AttributetypeId = 21,
                    //            obj.CountryID = 0,
                    //            obj.DisplayName = "Select All",
                    //            obj.Filter = parentList[0].DisplayName,
                    //            obj.FilterID = a.FilterID,
                    //            obj.FilterLevel = null,
                    //            obj.MetricName = "Select All",
                    //            obj.MetricParentName = a.DisplayName,
                    //            obj.SortID = 0,
                    //            obj.data = [],
                    //            obj.isDefaultLevel = false,
                    //            obj.isSingle = false;
                    //        if (a.data.filter(function (e) { return e.DisplayName == "Select All" }).length == 0)
                    //            a.data.unshift(angular.copy(obj));
                    //    }
                    //    angular.forEach(a.data, function (c, d) {
                    //        c.IsSelectable = true;
                    //        c.IsLastLevel = true;
                    //        c.ParentId = a.FilterID,
                    //            c.data = [];
                    //    })
                    //})

                    //  tempData = tempData.filter(value => value.rowNesting);
                    menusList.data = tempData;
                }
                else if (menusList.DisplayName.toUpperCase() == "BRAND" || (menusList.DisplayName.toUpperCase() == "COLUMN" && selectedColumn == "Brand") || (menusList.DisplayName.toUpperCase() == "ROW" && selectedRow == "Brand") || (menusList.DisplayName.toUpperCase() == "ROW NESTING" && selectedRowNesting == "Brand")) {
                    let itemList = [];
                    if (selectedItems.filter(function (e) { return e.DisplayName == "CATEGORY/ITEM/BRAND" }).length > 0 && parentList[0].DisplayName != "ADDITIONAL FILTERS") {
                        if ((sessionStorage.getItem("widgetInfo") != null && sessionStorage.getItem("widgetInfo") != "")) {
                            let widgetInfo = JSON.parse(sessionStorage.getItem("widgetInfo"));
                            selectionObj = JSON.parse(widgetInfo.SelectionObj);
                            selectedItems = selectionObj.filter(function (e) { return e.DisplayName != "" });
                        }
                        else if (stickySelection.length > 0) {
                            selectedItems = stickySelection.filter(function (e) { return e.DisplayName != "" });
                        }
                        let catItemBrandList = selectedItems.filter(function (e) { return e.DisplayName == "CATEGORY/ITEM/BRAND" });
                        let columnList = catItemBrandList[0].Data.filter(function (e) { return e.DisplayName == "Column" });
                        let rowList = catItemBrandList[0].Data.filter(function (e) { return e.DisplayName == "Row" });
                        if (menusList.DisplayName.toUpperCase() == "ROW NESTING") {
                            //tempData = tempData.filter(value => ((rowList[0].Data.filter(e => e.FilterID == value.FilterID).length > 0) ||
                            //    value.DisplayName.toUpperCase() == "SELECT ALL " + appendText + "BRANDS" || value.DisplayName.toUpperCase() == "SELECT ALL BRANDS" || value.DisplayName.toUpperCase() == "CUSTOM GROUP"))
                            let currTempData = []
                            for (let item in tempData) {
                                if (tempData[item].DisplayName.toUpperCase() == "SELECT ALL " + appendText + "BRANDS" || tempData[item].DisplayName.toUpperCase() == "SELECT ALL BRANDS" || tempData[item].DisplayName.toUpperCase() == "CUSTOM GROUP") {
                                    currTempData.push(tempData[item]);
                                }
                                else if ((rowList[0].Data.filter(e => e.FilterID == tempData[item].FilterID).length > 0)) {
                                    tempData[item].data = updateChildDetails(tempData[item].data, rowList[0].Data.filter(e => e.FilterID == tempData[item].FilterID)[0].Data)
                                    currTempData.push(tempData[item]);
                                }
                            }
                            tempData = currTempData;

                        }
                        if (menusList.DisplayName.toUpperCase() != "COLUMN" && catList.indexOf(selectedColumn) > -1 && catItemBrandList.length > 0 && columnList.length > 0) {
                            keepList = $scope.filterList(columnList, keepList);
                            if (selectedColumn.indexOf("Item") > -1) {
                                //  keepList = columnList[0].Data.select("DisplayName");

                                angular.forEach(menusList.data.filter(function (e) { return keepList.indexOf(e.DisplayName) > -1 }), function (a, b) {
                                    angular.forEach(a.data, function (c, d) {
                                        var obj = {};
                                        obj.Item = c.DisplayName;
                                        obj.Category = a.DisplayName;
                                        itemList.push(obj);
                                    })
                                })
                            }
                        }
                        if (selectedColumn != "Brand" && catList.indexOf(selectedColumn) > -1 && catItemBrandList.length > 0 && rowList.length > 0) {
                            try {
                                keepList = $scope.filterList(rowList, keepList);
                                if (selectedRow.indexOf("Item") > -1) {
                                    keepList = [];
                                    keepList = $scope.filterList(rowList, keepList);
                                    angular.forEach(menusList.data.filter(function (e) { return keepList.indexOf(e.DisplayName) > -1 }), function (a, b) {
                                        angular.forEach(a.data, function (c, d) {
                                            var obj = {};
                                            obj.Item = c.DisplayName;
                                            obj.Category = a.DisplayName;
                                            itemList.push(obj);
                                        })
                                    })
                                }
                            }
                            catch (ex) { }
                        }
                    }

                    //let adnList = selectedItems.filter(function (e) { return e.DisplayName == "ADDITIONAL FILTERS" });
                    //let adnListData;
                    //if (adnList.length > 0) {
                    //    adnListData = adnList[0].Data.filter(function (e) { return e.DisplayName == parentList[1].DisplayName });
                    //    if (adnListData.length > 0 && parentList[0].DisplayName == "ADDITIONAL FILTERS") {
                    //        let categoryList = adnListData[0].Data.filter(function (e) { return e.DisplayName.indexOf("Category") > -1 });
                    //        let itemsList = adnListData[0].Data.filter(function (e) { return e.DisplayName.indexOf("Item") > -1 });
                    //        if (categoryList.length > 0)
                    //            keepList = $scope.filterList(categoryList, keepList);
                    //        if (itemsList.length > 0) {
                    //            keepList = [];
                    //            keepList = $scope.filterList(itemsList, keepList);
                    //            angular.forEach(menusList.data.filter(function (e) { return keepList.indexOf(e.DisplayName) > -1 }), function (a, b) {
                    //                angular.forEach(a.Data, function (c, d) {
                    //                    var obj = {
                    //                    };
                    //                    obj.Item = c.DisplayName;
                    //                    obj.Category = a.DisplayName;
                    //                    itemList.push(obj);
                    //                })
                    //            })
                    //        }
                    //    }
                    //}
                    if (keepList.length > 0)
                        tempData = tempData.filter(function (e) { return keepList.indexOf(e.DisplayName) > -1 || e.DisplayName.toUpperCase() == "SELECT ALL " + appendText + "BRANDS" || e.DisplayName.toUpperCase() == "SELECT ALL BRANDS" });
                    tempData = tempData.filter(function (e) { return !e.IsLastLevel || e.DisplayName.toUpperCase() == "SELECT ALL " + appendText + "BRANDS" || e.DisplayName.toUpperCase() == "SELECT ALL BRANDS" });

                    if (itemList.length > 0) {
                        angular.forEach(tempData.filter(function (e) { return e.DisplayName != "Custom Group" }), function (a, b) {
                            //if (a.DisplayName.indexOf("Select All") == -1 && !a.IsLastLevel) {
                            //    a.IsSelectable = false;
                            //    a.IsLastLevel = false;
                            //}
                            var BrandData = [];
                            angular.forEach(a.data.filter(function (e) { return itemList.filter(function (e) { return e.Category == a.DisplayName }).select("Item").indexOf(e.DisplayName) > -1 }), function (c, d) {
                                //if (c.DisplayName.indexOf("Select All") == -1 && !a.IsLastLevel) {
                                //    c.IsSelectable = false;
                                //    c.IsLastLevel = false;
                                //    c.IsCollapsible = true;
                                //    c.IsExpanded = false;
                                //}
                                //temp = c.data;
                                //c.data = [];
                                BrandData.push(c);
                                //angular.forEach(temp, function (e, f) {
                                //    e.ParentId = c.FilterID,
                                //        e.IsSelectable = true;
                                //    e.IsLastLevel = true;
                                //    e.IsHidden = true;
                                //    e.ExtraPadding = true;
                                //    BrandData.push(e);
                                //})
                            })
                            a.data = BrandData;
                        })
                    }
                    //tempData = tempData.filter(function (e) { return e.data.length > 0 || e.DisplayName.toUpperCase() == "SELECT ALL " + appendText + "BRANDS" || e.DisplayName.toUpperCase() == "SELECT ALL BRANDS" });
                    menusList.data = tempData;
                }
                else if (menusList.DisplayName.toUpperCase() == "CATEGORY-MANUFACTURER" || menusList.DisplayName.toUpperCase() == "ITEM-MANUFACTURER" || (menusList.DisplayName.toUpperCase() == "COLUMN" && selectedColumn.toUpperCase().indexOf("MANUFACTURER") > -1) || (menusList.DisplayName.toUpperCase() == "ROW" && selectedRow.toUpperCase().indexOf("MANUFACTURER") > -1) || (menusList.DisplayName.toUpperCase() == "ROW NESTING" && selectedRowNesting.toUpperCase().indexOf("MANUFACTURER") > -1)) {
                    let bucketName = "";
                    if (menusList.DisplayName.toUpperCase().indexOf("MANUFACTURER") > -1)
                        bucketName = menusList.DisplayName.split("-")[0];
                    else if (selectedColumn.toUpperCase().indexOf("MANUFACTURER") > -1 && menusList.DisplayName.toUpperCase() == "COLUMN")
                        bucketName = selectedColumn.split("-")[0];
                    else if (selectedRow.toUpperCase().indexOf("MANUFACTURER") > -1 && menusList.DisplayName.toUpperCase() == "ROW")
                        bucketName = selectedRow.split("-")[0];
                    else if (selectedRowNesting.toUpperCase().indexOf("MANUFACTURER") > -1 && menusList.DisplayName.toUpperCase() == "ROW NESTING")
                        bucketName = selectedRowNesting.split("-")[0];
                    //  tempData = tempData.filter(function (e) { return e.DisplayName.toUpperCase() == appendText + bucketName.toUpperCase() + "-MANUFACTURER" })[0].data;
                    if (selectedItems.filter(function (e) { return e.DisplayName == "CATEGORY/ITEM/BRAND" }).length > 0 && parentList[0].DisplayName != "ADDITIONAL FILTERS") {
                        if ((sessionStorage.getItem("widgetInfo") != null && sessionStorage.getItem("widgetInfo") != "")) {
                            let widgetInfo = JSON.parse(sessionStorage.getItem("widgetInfo"));
                            selectionObj = JSON.parse(widgetInfo.SelectionObj);
                            selectedItems = selectionObj.filter(function (e) { return e.DisplayName != "" });
                        }
                        else if (stickySelection.length > 0) {
                            selectedItems = stickySelection.filter(function (e) { return e.DisplayName != "" });
                        }
                        let catItemBrandList = selectedItems.filter(function (e) { return e.DisplayName == "CATEGORY/ITEM/BRAND" })[0].Data;
                        let columnList = catItemBrandList.filter(function (e) { return e.DisplayName == "Column" });
                        let rowList = catItemBrandList.filter(function (e) { return e.DisplayName == "Row" });
                        let rowNestingList = catItemBrandList.filter(function (e) { return e.DisplayName == "Row Nesting" });
                        if (menusList.DisplayName.toUpperCase() == "ROW NESTING") {
                            //tempData = tempData.filter(value => ((rowList[0].Data.filter(e => e.FilterID == value.FilterID).length > 0) ||
                            // value.DisplayName.toUpperCase() == "SELECT ALL " + appendText + "BRANDS" || value.DisplayName.toUpperCase() == "SELECT ALL BRANDS" || value.DisplayName.toUpperCase() == "CUSTOM GROUP"))
                            let currTempData = []
                            
                            for (let item in tempData) {
                                if (tempData[item].DisplayName.toUpperCase().indexOf("SELECT ALL") > -1 || tempData[item].DisplayName.toUpperCase() == "CUSTOM GROUP") {
                                    currTempData.push(tempData[item]);
                                }
                                else if ((rowList[0].Data.filter(e => e.DisplayName == tempData[item].DisplayName).length > 0)) {
                                    tempData[item].data = updateChildDetails(tempData[item].data, rowList[0].Data.filter(e => e.DisplayName == tempData[item].DisplayName)[0].Data,"DisplayName")
                                    currTempData.push(tempData[item]);
                                }
                            }
                            tempData = currTempData;



                        }
                        if (menusList.DisplayName.toUpperCase() != "COLUMN" && columnList.length > 0) {
                            keepList = $scope.filterList(columnList, keepList);
                        }
                        if (menusList.DisplayName.toUpperCase() != "COLUMN" && menusList.DisplayName.toUpperCase() != "ROW" && rowList.length > 0) {
                            keepList = $scope.filterList(rowList, keepList);
                        }
                        if (menusList.DisplayName.toUpperCase() != "COLUMN" && menusList.DisplayName.toUpperCase() != "ROW" && menusList.DisplayName.toUpperCase() != "ROW NESTING" && rowNestingList.length > 0) {
                            keepList = $scope.filterList(rowNestingList, keepList);
                        }
                    }
                    //let adnList = selectedItems.filter(function (e) { return e.DisplayName == "ADDITIONAL FILTERS" });
                    //let adnListData;
                    //if (adnList.length > 0) {
                    //    adnListData = adnList[0].Data.filter(function (e) { return e.DisplayName == parentList[1].DisplayName });
                    //    if (adnListData.length > 0 && parentList[0].DisplayName == "ADDITIONAL FILTERS") {
                    //        let bucketList = adnListData[0].Data.filter(function (e) { return e.DisplayName == bucketName });
                    //        if (bucketList.length > 0)
                    //            keepList = $scope.filterList(bucketList, keepList);
                    //    }
                    //}
                    if (keepList.length > 0)
                        tempData = tempData.filter(function (e) { return keepList.indexOf(e.DisplayName) > -1 || e.DisplayName == "Custom Group" });

                    if (bucketName != "Category") {
                        angular.forEach(tempData.filter(function (e) { return e.DisplayName != "Custom Group" }), function (a, b) {
                            if (a.DisplayName.indexOf("Select All") == -1) {
                                a.data = a.data.filter(function (val) { return val.data.length > 0 });
                            }
                        })
                    }

                    tempData = tempData.filter(function (e) { return e.data.length > 0 || e.DisplayName == "Custom Group" });
                    menusList.data = angular.copy(tempData);
                }
            }
            else if (menusList.DisplayName.toUpperCase() == "DEMOGRAPHICS" || ((menusList.DisplayName.toUpperCase() == "COLUMN" || menusList.DisplayName.toUpperCase() == "ROW" || menusList.DisplayName.toUpperCase() == "ROW NESTING") && parentList[0].DisplayName == "DEMOGRAPHICS")) {
                if (menusList.isDefaultLevel) {
                    menusList.data = angular.copy(bindStaticList(menusList.DisplayName, parentList[0].DisplayName));
                    menusList.data.filter(function (e) { return e.IsSelectable = false });
                    menusList.data.filter(function (e) { return e.IsLastLevel = false })
                    menusList.data.filter(function (e) { return e.isDisabled = false });
                    if (selectedColumn != "Demographics")
                        menusList.data[0].isDisabled = true;
                    if (selectedRow != "Demographics")
                        menusList.data[1].isDisabled = true;
                    if (selectedRowNesting != "Demographics")
                        menusList.data[2].isDisabled = true;
                }
                else {
                    let tempData = $scope.getDemographicsData();
                    if (menusList.DisplayName == "Column" || parentList[0].DisplayName == "ADDITIONAL FILTERS")
                        menusList.data = tempData;
                    else if (parentList[0].DisplayName != "ADDITIONAL FILTERS") {
                        modifyData(menusList, "DEMOGRAPHICS", tempData);
                        if (/*menusList.DisplayName == "Row" || */menusList.DisplayName == "Row Nesting") {
                            menusList.data.filter(function (e) { return e.isSingle = true });
                            if (menusList.data.filter(function (e) { return e.DisplayName == "Age" }).length > 0) {
                                menusList.data.filter(function (e) { return e.DisplayName == "Age" })[0].data.filter(function (e) { return e.isSingle = true });
                            }
                        }
                    }
                }
            }
            else if (menusList.DisplayName.toUpperCase() == "5WS" || ((menusList.DisplayName.toUpperCase() == "COLUMN" || menusList.DisplayName.toUpperCase() == "ROW" || menusList.DisplayName.toUpperCase() == "ROW NESTING") && parentList[0].DisplayName == "5Ws")) {
                let removeList = [];
                if (menusList.isDefaultLevel) {
                    menusList.data = angular.copy(bindStaticList("5Ws", parentList[0].DisplayName));
                    menusList.data.filter(function (e) { return e.IsSelectable = false });
                    menusList.data.filter(function (e) { return e.IsLastLevel = false });
                    menusList.data.filter(function (e) { return e.isDisabled = false });
                    if (selectedColumn != "5Ws")
                        menusList.data[0].isDisabled = true;
                    if (selectedRow != "5Ws")
                        menusList.data[1].isDisabled = true;
                    if (selectedRowNesting != "5Ws")
                        menusList.data[2].isDisabled = true;
                }
                else {
                    let countryIds = $scope.returnCountryIds();
                    menusList.data = angular.copy($scope.modifyMarketDependency(LeftPanelOriginalData.filter(function (e) { return e.DisplayName.toUpperCase() == "5WS" })[0].data, countryIds, menusList, parentList));
                    if (countryIds.length > 1)
                        menusList.data = $scope.filterDups(menusList.data, countryIds.length);
                    if (parentList[0].DisplayName != "ADDITIONAL FILTERS") {
                        if ((sessionStorage.getItem("widgetInfo") != null && sessionStorage.getItem("widgetInfo") != "")) {
                            let widgetInfo = JSON.parse(sessionStorage.getItem("widgetInfo"));
                            selectionObj = JSON.parse(widgetInfo.SelectionObj);
                            selectedItems = selectionObj.filter(function (e) { return e.DisplayName != "" });
                        }
                        else if (stickySelection.length > 0) {
                            selectedItems = stickySelection.filter(function (e) { return e.DisplayName != "" });
                        }
                        let wsList = [];
                        if (selectedItems.filter(function (e) { return e.DisplayName == "5Ws" }).length > 0)
                            wsList = selectedItems.filter(function (e) { return e.DisplayName == "5Ws" })[0].Data;
                        if (menusList.DisplayName == "Row" /*|| parentList[0].DisplayName == "ADDITIONAL FILTERS"*/) {
                            if (selectedColumn == "5Ws") {
                                let columnMetric = wsList.filter(function (e) { return e.DisplayName == "Column" })[0].Data;
                                filterChannels(columnMetric, menusList)
                            }
                        }
                        if (menusList.DisplayName == "Row Nesting") {
                            if (selectedColumn == "5Ws") {
                                let columnMetric = wsList.filter(function (e) { return e.DisplayName == "Column" })[0].Data;
                                filterChannels(columnMetric, menusList);
                            }
                            if (selectedRow == "5Ws") {
                                let rowMetric = wsList.filter(function (e) { return e.DisplayName == "Row" })[0].Data;
                                filterChannels(rowMetric, menusList);
                            }
                        }
                        //if (parentList[0].DisplayName == "ADDITIONAL FILTERS") {
                        //    menusList.data.filter(function (e) { return e.DisplayName == "What" })[0].data = menusList.data.filter(function (e) { return e.DisplayName == "What" })[0].data.filter(function (e) { return !e.IsLastLevel });
                        //    if (getSelectedMainValues().Row == "5Ws") {
                        //        let rowMetric = wsList.filter(function (e) { return e.DisplayName == "Row" })[0].Data;
                        //        filterChannels(rowMetric, menusList)
                        //    }
                        //    if (getSelectedMainValues().RowNesting == "5Ws") {
                        //        let rowMetric = wsList.filter(function (e) { return e.DisplayName == "Row Nesting" })[0].Data;
                        //        filterChannels(rowMetric, menusList)
                        //    }
                        //}
                        if (menusList.DisplayName == "Row" || menusList.DisplayName == "Row Nesting") {
                            menusList.data.filter(function (e) { return e.isSingle = true });
                            //angular.forEach(menusList.data.filter(function (e) { return e.DisplayName == "When" || e.DisplayName =="Purchase" }),function (a, b) {
                            //    a.data.filter(function (e) { return e.isSingle = true });
                            //})
                        }
                        //let marketList = $scope.getPKsAndName(selectedItems.filter(function (e) { return e.DisplayName == "MARKETS" }), []).select("DisplayName");
                        //if ((marketList.length > 1 || MarketRegionList.select("Region").distinct().diff(marketList).length < MarketRegionList.select("Region").distinct().length) && (menusList.DisplayName == "Column" || menusList.DisplayName == "Row" || menusList.DisplayName == "Row Nesting") && getSelectedMainValues().Column != "Market") {
                        //    angular.forEach(menusList.data.filter(function (e) { return e.DisplayName == "Purchase" })[0].data, function (a, b) {
                        //        if (a.DisplayName.toUpperCase().indexOf("CHANNEL") > -1 || a.DisplayName.toUpperCase().indexOf("RETAILER") > -1)
                        //            a.isDisabled = true;
                        //    })
                        //}

                    }
                    $scope.validationForCanada(menusList);
                    //$scope.addSelectAllForChannelAndRetailer(menusList, parentList);
                }
            }
            else if (LeftPanelOriginalData.filter(function (e) { return e.DisplayName.toUpperCase() == menusList.DisplayName.toUpperCase() }).length > 0) {
                let tempData = angular.copy(LeftPanelOriginalData.filter(function (e) { return e.DisplayName.toUpperCase() == menusList.DisplayName.toUpperCase() })[0].data);
                if (menusList.DisplayName.toUpperCase() != "MARKETS") {
                    let countryIds = $scope.returnCountryIds();
                    tempData = angular.copy($scope.modifyMarketDependency(LeftPanelOriginalData.filter(function (e) { return e.DisplayName.toUpperCase() == menusList.DisplayName.toUpperCase() })[0].data, countryIds, menusList, parentList));
                    if (countryIds.length > 1)
                        tempData = $scope.filterDups(tempData, countryIds.length);
                    if (parentList[0].DisplayName == "5Ws" || parentList[1].DisplayName == "5Ws") {
                        menusList.data = tempData;
                        if ((sessionStorage.getItem("widgetInfo") != null && sessionStorage.getItem("widgetInfo") != "")) {
                            let widgetInfo = JSON.parse(sessionStorage.getItem("widgetInfo"));
                            selectionObj = JSON.parse(widgetInfo.SelectionObj);
                            selectedItems = selectionObj.filter(function (e) { return e.DisplayName != "" });
                        }
                        else if (stickySelection.length > 0) {
                            selectedItems = stickySelection.filter(function (e) { return e.DisplayName != "" });
                        }
                        let wsList = [];
                        if (selectedItems.filter(function (e) { return e.DisplayName == "5Ws" }).length > 0)
                            wsList = selectedItems.filter(function (e) { return e.DisplayName == "5Ws" })[0].Data;
                        if (parentList[1].DisplayName == "Row" /*|| parentList[0].DisplayName == "ADDITIONAL FILTERS"*/) {
                            if (selectedColumn == "5Ws") {
                                let columnMetric = wsList.filter(function (e) { return e.DisplayName == "Column" })[0].Data;
                                filterChannels(columnMetric, parentList[1])
                            }
                        }
                        if (parentList[1].DisplayName == "Row Nesting") {
                            if (selectedColumn == "5Ws") {
                                let columnMetric = wsList.filter(function (e) { return e.DisplayName == "Column" })[0].Data;
                                filterChannels(columnMetric, parentList[1]);
                            }
                            if (selectedRow == "5Ws") {
                                let rowMetric = wsList.filter(function (e) { return e.DisplayName == "Row" })[0].Data;
                                filterChannels(rowMetric, parentList[1]);
                            }
                        }
                        //if (parentList[0].DisplayName == "ADDITIONAL FILTERS") {
                        //    menusList.data.filter(function (e) { return e.DisplayName == "What" })[0].data = menusList.data.filter(function (e) { return e.DisplayName == "What" })[0].data.filter(function (e) { return !e.IsLastLevel });
                        //    if (getSelectedMainValues().Row == "5Ws") {
                        //        let rowMetric = wsList.filter(function (e) { return e.DisplayName == "Row" })[0].Data;
                        //        filterChannels(rowMetric, menusList)
                        //    }
                        //    if (getSelectedMainValues().RowNesting == "5Ws") {
                        //        let rowMetric = wsList.filter(function (e) { return e.DisplayName == "Row Nesting" })[0].Data;
                        //        filterChannels(rowMetric, menusList)
                        //    }
                        //}
                        if (parentList[1].DisplayName == "Row" || parentList[1].DisplayName == "Row Nesting") {
                            //menusList.data.filter(function (e) { return e.isSingle = true });
                            angular.forEach(parentList[1].data.filter(function (e) { return e.DisplayName == "When" || e.DisplayName == "Purchase" }), function (a, b) {
                                a.data.filter(function (e) { return e.isSingle = true });
                            })
                        }
                        //let marketList = $scope.getPKsAndName(selectedItems.filter(function (e) { return e.DisplayName == "MARKETS" }), []).select("DisplayName");
                        //if ((marketList.length > 1 || MarketRegionList.select("Region").distinct().diff(marketList).length < MarketRegionList.select("Region").distinct().length) && (menusList.DisplayName == "Column" || menusList.DisplayName == "Row" || menusList.DisplayName == "Row Nesting") && getSelectedMainValues().Column != "Market") {
                        //    angular.forEach(menusList.data.filter(function (e) { return e.DisplayName == "Purchase" })[0].data, function (a, b) {
                        //        if (a.DisplayName.toUpperCase().indexOf("CHANNEL") > -1 || a.DisplayName.toUpperCase().indexOf("RETAILER") > -1)
                        //            a.isDisabled = true;
                        //    })
                        //}

                    }
                    $scope.validationForCanada(menusList);
                }
                menusList.data = tempData;
            }

            if (menusList.data.filter(function (e) { return e.DisplayName.indexOf("Select All") == -1 }).length == 0) {
                show_popup("Alert", customMessages.NoCommonMetric);
                return false;
            }

            //making first Level Single Selection
            if (menusList.DisplayName == "COLUMN" || menusList.DisplayName == "ROW" || menusList.DisplayName == "ROW NESTING" || menusList.DisplayName == "BENCHMARK")
                applyToChild(menusList, ["isSingle"], true)
            if (menusList.DisplayName == "ADDITIONAL FILTERS") {
                applyToChild(menusList, ["isSingle"], false)
            }
            if (selectedColumn != "Market" && selectedRow != "Market" && selectedRowNesting != "Market" && menusList.DisplayName == "MARKETS") {
                menusList.data = menusList.data.filter(function (e) { return e.DisplayName.indexOf("Select All Regions") == -1 });
                //     let timeList = $scope.getPKsAndName(selectedItems.filter(function (e) { return e.DisplayName == "TIME PERIOD" })[0].Data, []);
                //if (timeList.length > 1 && getSelectedMainValues().Column == "Time Period")
                //    menusList.data = menusList.data.filter(function (e) { return e.DisplayName.indexOf("Select All") == -1 });
            }

            $scope.validationForAustraliaandGroup(parentList, menusList);


            return true;
        }

        //function to bind channels and retailers
        function filterChannels(list, menusList) {
            let isRetailSelected = 0, isChannelSelected = 0;
            let channelBucket = "";
            let purchaseList = list.filter(function (e) { return e.DisplayName == "Purchase" });
            let channelsList = [], retailerList = [];
            if (purchaseList.length > 0) {
                if (purchaseList[0].Data.filter(function (e) { return e.DisplayName.toUpperCase().indexOf("CHANNEL") > -1 }).length > 0)
                    channelsList = purchaseList[0].Data.filter(function (e) { return e.DisplayName.toUpperCase().indexOf("CHANNEL") > -1 });
                else if (purchaseList[0].Data.filter(function (e) { return e.DisplayName.toUpperCase().indexOf("RETAILER") > -1 }).length > 0)
                    retailerList = purchaseList[0].Data.filter(function (e) { return e.DisplayName.toUpperCase().indexOf("RETAILER") > -1 });
            }
            if (channelsList.length > 0) {
                channelBucket = channelsList[0].DisplayName;
                if (channelsList[0].Data.filter(function (e) { return e.DisplayName != "Custom Group Channel" && e.Data.length > 0 }).length > 0)//Retailer is selected
                    isRetailSelected = 1;
                else if (channelBucket.toUpperCase() == "CHANNEL NETS")
                    isRetailSelected = 1;
                else
                    isChannelSelected = 1;//Channel is selected
            }
            else if (retailerList.length > 0) {
                isRetailSelected = 1;
            }
            removeList = list.filter(function (e) { return e.DisplayName != "When" && e.DisplayName != "What" && e.DisplayName != "Purchase" && e.DisplayName.toUpperCase() != "COVID BEHAVIOURS" }).select("DisplayName");
            menusList.data.filter(function (e) { return removeList.indexOf(e.DisplayName) > -1 }).filter(function (e) { return e.isDisabled = true })
            let remove = [];
            let keepList = list.filter(function (e) { return e.DisplayName == "When" || e.DisplayName == "What" || e.DisplayName == "Purchase" || e.DisplayName.toUpperCase() == "COVID BEHAVIOURS" });
            let purchaseBucketData = menusList.data.filter(function (e) { return e.DisplayName == "Purchase" })[0].data;
            if (purchaseBucketData.length > 0) {
                angular.forEach(keepList, function (a, b) {
                    remove = remove.concat(a.Data.filter(function (e) { return e.DisplayName != channelBucket }).select("DisplayName"));
                    if (isRetailSelected && channelBucket != "")
                        remove = remove.concat(channelBucket).concat("RETAILER NETS");
                    if (channelBucket != "" || isRetailSelected)
                        remove = remove.concat(purchaseBucketData.filter(function (e) { return e.DisplayName.toUpperCase().indexOf("CHANNEL") > -1 && e.DisplayName != channelBucket }).select("DisplayName"));
                    if (isChannelSelected) {
                        let channelSelected = [];
                        channelSelected = $scope.filterList(purchaseList[0].Data.filter(function (e) { return e.DisplayName == channelBucket }), channelSelected);
                        let channelBucketData = purchaseBucketData.filter(function (e) { return e.DisplayName == channelBucket })[0].data;
                        purchaseBucketData.filter(function (e) { return e.DisplayName == channelBucket })[0].data = channelBucketData.filter(function (e) { return (channelSelected.indexOf(e.DisplayName) > -1 && !e.IsLastLevel) || (e.DisplayName.toUpperCase().indexOf("SELECT ALL") > -1 && e.DisplayName.toUpperCase().indexOf("RETAILERS") > -1) });
                        channelBucketData = purchaseBucketData.filter(function (e) { return e.DisplayName == channelBucket })[0].data;
                        remove = remove.concat("RETAILER NETS");
                        if (channelBucket == "Custom Channel") {
                            let newlist = menusList.data.filter(function (e) { return e.DisplayName == "Purchase" })[0].data.filter(function (e) { return e.DisplayName == channelBucket })[0].data;
                            angular.forEach(newlist, function (c, d) {
                                if (!c.IsLastLevel)
                                    c.IsSelectable = false;
                                c.data = c.data.filter(function (e) { return customRetailersAttributeIds.indexOf(e.AttributetypeId) > -1 || e.IsLastLevel || e.data.length > 0 || (e.DisplayName.indexOf("Select All") > -1 && e.DisplayName.indexOf("Retailers") > -1) });
                                if (c.data.length > 0) {
                                    c.data.filter(function (e) { return e.DisplayName != "Select All Retailers" && !e.IsLastLevel }).filter(function (e) { return e.IsSelectable = false });
                                    angular.forEach(c.data.filter(function (val) { return val.DisplayName.indexOf("Select All") == -1 }), function (val1, ind1) {
                                        if (!val1.IsLastLevel)
                                            val1.IsSelectable = false;
                                        val1.data = val1.data.filter(function (e) { return e.IsLastLevel || customRetailersAttributeIds.indexOf(e.AttributetypeId) > -1 });
                                    })
                                }
                            })
                            menusList.data.filter(function (e) { return e.DisplayName == "Purchase" })[0].data.filter(function (e) { return e.DisplayName == channelBucket })[0].data = newlist.filter(function (e) { return e.data.length > 0 || (e.DisplayName.toUpperCase().indexOf("SELECT ALL") > -1 && e.DisplayName.toUpperCase().indexOf("RETAILERS") > -1) });
                        }
                        else {
                            channelBucketData.filter(function (e) { return e.DisplayName.toUpperCase().indexOf("SELECT ALL") == -1 }).filter(function (e) { return e.IsSelectable = false });
                        }
                    }
                    if (purchaseBucketData.filter(function (e) { return e.DisplayName == channelBucket }).length > 0) {
                        purchaseBucketData.filter(function (e) { return e.DisplayName == channelBucket })[0].isChannelSelected = isChannelSelected;
                    }
                    //menusList.data.filter(function (e) { return e.DisplayName == a.DisplayName })[0].data.filter(function (e) { return remove.map(function (e) { return e.toUpperCase() }).indexOf(e.DisplayName.toUpperCase()) > -1 }).filter(function (e) { return e.isDisabled = true })
                })
            }
        }

        //function to bind static first level
        function bindStaticList(name, parent) {
            var temp = [], list = [];

            if ((name == "Category/Item/Brand" && parent == "CATEGORY/ITEM/BRAND") || name == "DEMOGRAPHICS" || name == "5Ws")
                list = ["Column", "Row", "Row Nesting"];

            for (i = 0; i < list.length; i++) {
                let isDisabled = false;
                var obj = {};
                obj.AttributeId = i + 1;
                obj.AttributetypeId = i + 1;
                obj.CountryID = 0;
                obj.DisplayName = list[i];
                obj.Filter = name;
                obj.FilterID = i + 1;
                obj.IsLastLevel = (name.indexOf("Category/Item/Brand") > -1 ? false : true);
                obj.IsSelectable = (name.indexOf("Category/Item/Brand") > -1 ? false : true);
                obj.MetricName = list[i];
                obj.MetricParentName = name;
                obj.ParentId = null;
                obj.SortID = i + 1;
                obj.data = [];
                obj.isDefaultLevel = false;
                obj.isDisabled = isDisabled;
                obj.isSingle = false;
                if ((list[i] == "Column" || list[i] == "Row" || list[i] == "Row Nesting") && name != "5Ws")
                    obj.isGroupNeeded = true;
                temp.push(obj);
            }
            return temp;
        }

        //function to check if all mandatory selections are made or not
        function requiredValidations(menusList, parentList) {
            if (menusList.DisplayName == "COLUMN") {
                return true;
            }
            else if ((selectedItems == undefined || selectedItems.length == 0) && menusList.DisplayName != "COLUMN") {
                show_popup("Alert", customMessages.ColumnSelection)
                return false;
            }
            else if (menusList.DisplayName == "ROW") {
                if (!selectedItems.some(function (e) { return e.DisplayName == "COLUMN" })) {
                    show_popup("Alert", customMessages.ColumnSelection)
                    return false;
                }
            }
            else if (menusList.DisplayName == "ROW NESTING") {
                if (!selectedItems.some(function (e) { return e.DisplayName == "ROW" })) {
                    show_popup("Alert", customMessages.RowSelection)
                    return false;
                }
            }
            else if (!selectedItems.some(function (e) { return e.DisplayName == "COLUMN" })) {
                show_popup("Alert", customMessages.ColumnSelection)
                return false;
            }
            else if (!selectedItems.some(function (e) { return e.DisplayName == "ROW" })) {
                show_popup("Alert", customMessages.RowSelection)
                return false;
            }
            else if (!selectedItems.some(function (e) { return e.DisplayName == "TIME PERIOD" }) && menusList.DisplayName != "TIME PERIOD") {
                show_popup("Alert", customMessages.Timeperiod)
                return false;
            }
            else if (menusList.DisplayName != "TIME PERIOD" && !$scope.multiTimePeriodValidation()) {
                show_popup("Alert", customMessages.ConsecutiveTimePeriodSelection);
                return false;
            }
            else if (!selectedItems.some(function (e) { return e.DisplayName == "MARKETS" }) && menusList.DisplayName != "TIME PERIOD" && menusList.DisplayName != "MARKETS" && menusList.DisplayName != "BENCHMARK") {
                show_popup("Alert", customMessages.MarketSelection)
                return false;
            }
            else if (menusList.DisplayName != "TIME PERIOD" && menusList.DisplayName != "MARKETS" && menusList.DisplayName != "BENCHMARK") {
                if ((sessionStorage.getItem("widgetInfo") != null && sessionStorage.getItem("widgetInfo") != "")) {
                    let widgetInfo = JSON.parse(sessionStorage.getItem("widgetInfo"));
                    selectionObj = JSON.parse(widgetInfo.SelectionObj);
                    selectedItems = selectionObj.filter(function (e) { return e.DisplayName != "" });
                }
                else if (stickySelection.length > 0) {
                    selectedItems = stickySelection.filter(function (e) { return e.DisplayName != "" });
                }
                curscope = angular.element("#left-pane-container").scope();
                let obj = getSelectedMainValues();
                let selectedRowNesting = obj.RowNesting, selectedRow = obj.Row, selectedColumn = obj.Column;
                let availableItems = scenarios.filter(function (e) { return e.Column == selectedColumn && e.Row == selectedRow && e.RowNesting == selectedRowNesting })[0];
                if (!selectedItems.some(function (e) { return e.DisplayName == "OCCASION" }) && availableItems.Occasion != 'Disabled' && menusList.DisplayName != "OCCASION") {
                    show_popup("Alert", customMessages.OccasionSelection)
                    return false;
                }
                else if (!selectedItems.some(function (e) { return e.DisplayName == "CATEGORY/ITEM/BRAND" }) && availableItems.Category != 'Disabled' && menusList.DisplayName != "OCCASION" && menusList.DisplayName != "CATEGORY/ITEM/BRAND") {
                    show_popup("Alert", customMessages.CategorySelection)
                    return false;
                }
                else if (!selectedItems.some(function (e) { return e.DisplayName == "5Ws" }) && availableItems.Metric != 'Disabled' && menusList.DisplayName != "OCCASION" && menusList.DisplayName != "CATEGORY/ITEM/BRAND" && menusList.DisplayName != "5Ws") {
                    show_popup("Alert", customMessages.MetricSelection)
                    return false;
                }
                else if (!selectedItems.some(function (e) { return e.DisplayName == "DEMOGRAPHICS" }) && availableItems.Demographics != 'Disabled' && menusList.DisplayName != "OCCASION" && menusList.DisplayName != "CATEGORY/ITEM/BRAND" && menusList.DisplayName != "5Ws" && menusList.DisplayName != "DEMOGRAPHICS") {
                    show_popup("Alert", customMessages.DemographicSelection)
                    return false;
                }
                else if (availableItems.Category != 'Disabled' && curscope.LeftStaticMenu.filter(function (e) { return e.DisplayName == "CATEGORY/ITEM/BRAND" })[0].data.filter(function (e) { return !e.isDisabled }).length != curscope.LeftStaticMenu.filter(function (e) { return e.DisplayName == "CATEGORY/ITEM/BRAND" })[0].data.filter(function (e) { return curscope.hasChildSelected(e) }).length && menusList.DisplayName != "CATEGORY/ITEM/BRAND" && menusList.DisplayName != "OCCASION") {
                    if (!curscope.LeftStaticMenu.filter(function (e) { return e.DisplayName == "CATEGORY/ITEM/BRAND" })[0].data.filter(function (e) { return e.DisplayName == "Row" })[0].isDisabled && !curscope.LeftStaticMenu.filter(function (e) { return e.DisplayName == "CATEGORY/ITEM/BRAND" })[0].data.filter(function (e) { return e.DisplayName == "Row" })[0].hasChildSelected) {
                        show_popup("Alert", customMessages.RowSelection)
                        return false;
                    }
                    else {
                        show_popup("Alert", customMessages.RowNestingSelection)
                        return false;
                    }
                }
                else if (availableItems.Metric != 'Disabled' && curscope.LeftStaticMenu.filter(function (e) { return e.DisplayName == "5Ws" })[0].data.filter(function (e) { return !e.isDisabled }).length != curscope.LeftStaticMenu.filter(function (e) { return e.DisplayName == "5Ws" })[0].data.filter(function (e) { return curscope.hasChildSelected(e) }).length && menusList.DisplayName != "OCCASION" && menusList.DisplayName != "CATEGORY/ITEM/BRAND" && menusList.DisplayName != "5Ws") {
                    if (!curscope.LeftStaticMenu.filter(function (e) { return e.DisplayName == "5Ws" })[0].data.filter(function (e) { return e.DisplayName == "Row" })[0].isDisabled && !curscope.LeftStaticMenu.filter(function (e) { return e.DisplayName == "5Ws" })[0].data.filter(function (e) { return e.DisplayName == "Row" })[0].hasChildSelected) {
                        show_popup("Alert", customMessages.RowSelection)
                        return false;
                    }
                    else {
                        show_popup("Alert", customMessages.RowNestingSelection)
                        return false;
                    }
                }
                else if (availableItems.Demographics != 'Disabled' && curscope.LeftStaticMenu.filter(function (e) { return e.DisplayName == "DEMOGRAPHICS" })[0].data.filter(function (e) { return !e.isDisabled }).length != curscope.LeftStaticMenu.filter(function (e) { return e.DisplayName == "DEMOGRAPHICS" })[0].data.filter(function (e) { return curscope.hasChildSelected(e) }).length && menusList.DisplayName != "OCCASION" && menusList.DisplayName != "CATEGORY/ITEM/BRAND" && menusList.DisplayName != "5Ws" && menusList.DisplayName != "DEMOGRAPHICS") {
                    if (!curscope.LeftStaticMenu.filter(function (e) { return e.DisplayName == "DEMOGRAPHICS" })[0].data.filter(function (e) { return e.DisplayName == "Row" })[0].isDisabled && !curscope.LeftStaticMenu.filter(function (e) { return e.DisplayName == "DEMOGRAPHICS" })[0].data.filter(function (e) { return e.DisplayName == "Row" })[0].hasChildSelected) {
                        show_popup("Alert", customMessages.RowSelection)
                        return false;
                    }
                    else {
                        show_popup("Alert", customMessages.RowNestingSelection)
                        return false;
                    }
                }
            }
            return true;
        }

        //function to enable or disable necessary tabs
        function enableDisableTabs(menusList, parentList, scope) {
            if (menusList.isDefaultLevel) {
                if (!requiredValidations(menusList, parentList))
                    return false;
            }
            if (menusList.DisplayName == "ROW") {
                let selectedColumn = getSelectedMainValues().Column;
                let selBucket = "";
                if (catList.indexOf(selectedColumn) > -1)
                    selBucket = $scope.getPKsAndName(selectedItems.filter(function (e) { return e.DisplayName == "COLUMN" })[0].Data, [])[0].Parent;
                let availableItems = scenarios.filter(function (e) { return e.Column == selectedColumn }).select("Row").distinct();
                angular.forEach(menusList.data, function (value, index) {
                    if (value.DisplayName.indexOf("Category/Item/Brand") > -1 && selBucket != "" && value.DisplayName == selBucket) {
                        angular.forEach(value.data, function (value1, index) {
                            if (availableItems.indexOf(value1.DisplayName) == -1) {
                                value1.isDisabled = true;
                            }
                            else
                                value1.isDisabled = false;
                            /*special case for custom bucket*/
                            if (selBucket.indexOf("Custom") > -1) {
                                if (selectedColumn == "Category" && value1.DisplayName == "Brand")
                                    value1.isDisabled = true;
                                if (selectedColumn == "Brand" && value1.DisplayName == "Category")
                                    value1.isDisabled = true;
                            }
                        })
                        menusList.data.filter(function (e) { return e.DisplayName == selBucket })[0].isDisabled = false;
                        if (menusList.data.filter(function (e) { return e.DisplayName == selBucket })[0].data.filter(function (e) { return e.isDisabled }).length == menusList.data.filter(function (e) { return e.DisplayName == selBucket })[0].data.length)
                            menusList.data.filter(function (e) { return e.DisplayName == selBucket })[0].isDisabled = true;
                    }
                    else {
                        if (availableItems.indexOf(value.DisplayName) == -1) {
                            value.isDisabled = true;
                        }
                        else
                            value.isDisabled = false;
                        if (selBucket == "" && value.DisplayName.indexOf("Category/Item/Brand") > -1)
                            value.isDisabled = false;
                    }
                });
            }
            else if (menusList.DisplayName == "ROW NESTING") {
                let obj = getSelectedMainValues();
                let selectedRow = obj.Row, selectedColumn = obj.Column;
                let selBucket = "";
                if (catList.indexOf(selectedColumn) > -1)
                    selBucket = $scope.getPKsAndName(selectedItems.filter(function (e) { return e.DisplayName == "COLUMN" })[0].Data, [])[0].Parent;
                if (catList.indexOf(selectedRow) > -1)
                    selBucket = $scope.getPKsAndName(selectedItems.filter(function (e) { return e.DisplayName == "ROW" })[0].Data, [])[0].Parent;
                let availableItems = scenarios.filter(function (e) { return e.Column == selectedColumn && e.Row == selectedRow && e.RowNesting != "" }).select("RowNesting").distinct();
                angular.forEach(menusList.data, function (value, index) {
                    if (value.DisplayName.indexOf("Category/Item/Brand") > -1 && selBucket != "" && value.DisplayName == selBucket) {
                        angular.forEach(value.data, function (value1, index) {
                            if (availableItems.indexOf(value1.DisplayName) == -1) {
                                value1.isDisabled = true;
                            }
                            else
                                value1.isDisabled = false;
                        })
                        menusList.data.filter(function (e) { return e.DisplayName == selBucket })[0].isDisabled = false;
                        if (menusList.data.filter(function (e) { return e.DisplayName == selBucket })[0].data.filter(function (e) { return e.isDisabled }).length == menusList.data.filter(function (e) { return e.DisplayName == selBucket })[0].data.length)
                            menusList.data.filter(function (e) { return e.DisplayName == selBucket })[0].isDisabled = true;
                    }
                    else {
                        if (availableItems.indexOf(value.DisplayName) == -1) {
                            value.isDisabled = true;
                        }
                        else
                            value.isDisabled = false;
                        if (selBucket == "" && value.DisplayName.indexOf("Category/Item/Brand") > -1)
                            value.isDisabled = false;
                    }
                });
            }

            let obj = getSelectedMainValues();
            let selectedRowNesting = obj.RowNesting, selectedRow = obj.Row, selectedColumn = obj.Column;
            let selBucket = "";
            if (catList.indexOf(selectedColumn) > -1)
                selBucket = $scope.getPKsAndName(selectedItems.filter(function (e) { return e.DisplayName == "COLUMN" })[0].Data, [])[0].Parent;
            if (catList.indexOf(selectedRow) > -1)
                selBucket = $scope.getPKsAndName(selectedItems.filter(function (e) { return e.DisplayName == "ROW" })[0].Data, [])[0].Parent;
            if (catList.indexOf(selectedRowNesting) > -1)
                selBucket = $scope.getPKsAndName(selectedItems.filter(function (e) { return e.DisplayName == "ROW NESTING" })[0].Data, [])[0].Parent;
            let availableItems = [];
            if (scenarios != undefined)
                availableItems = scenarios.filter(function (e) { return e.Column == selectedColumn && e.Row == selectedRow && e.RowNesting == selectedRowNesting })[0];

            if (availableItems != undefined && !$scope.hasChildSelected(menusList)) {
                scope.LeftStaticMenu.filter(function (e) { return e.DisplayName == "OCCASION" })[0].isDisabled = false;
                scope.LeftStaticMenu.filter(function (e) { return e.DisplayName == "CATEGORY/ITEM/BRAND" })[0].isDisabled = false;
                scope.LeftStaticMenu.filter(function (e) { return e.DisplayName == "5Ws" })[0].isDisabled = false;
                scope.LeftStaticMenu.filter(function (e) { return e.DisplayName == "DEMOGRAPHICS" })[0].isDisabled = false;
                if (menusList.DisplayName == "TIME PERIOD" && menusList.isDefaultLevel) {
                    if (availableItems.TimePeriod == "Single") {
                        applyToChild(menusList, ["isSingle"], true);
                    }
                    else if (availableItems.TimePeriod == "Multiple") {
                        applyToChild(menusList.data, ["isSingle"], false);
                    }
                }
                else if (menusList.DisplayName == "MARKETS" && menusList.isDefaultLevel) {
                    if (availableItems.Market == "Single") {
                        applyToChild(menusList, ["isSingle"], true);
                    }
                    else if (availableItems.Market == "Multiple") {
                        applyToChild(menusList, ["isSingle"], false);
                    }
                }
                else if (menusList.DisplayName == "OCCASION" && menusList.isDefaultLevel) {
                    if (availableItems.Occasion == "Multiple") {
                        applyToChild(menusList, ["isSingle"], false);
                    }
                }
                else if (menusList.DisplayName == "CATEGORY/ITEM/BRAND" && menusList.isDefaultLevel) {
                    if (availableItems.Category == "Multiple") {
                        applyToChild(menusList, ["isSingle"], false);
                    }
                    menusList.data.filter(function (e) { return e.DisplayName == "Column" })[0].isDisabled = (catList.indexOf(selectedColumn) > -1 ? false : true);
                    menusList.data.filter(function (e) { return e.DisplayName == "Row" })[0].isDisabled = (catList.indexOf(selectedRow) > -1 ? false : true);
                    menusList.data.filter(function (e) { return e.DisplayName == "Row Nesting" })[0].isDisabled = (catList.indexOf(selectedRowNesting) > -1 ? false : true);
                }
                else if (menusList.DisplayName == "5Ws" && menusList.isDefaultLevel) {
                    if (availableItems.Metric == "Multiple") {
                        applyToChild(menusList, ["isSingle"], false);
                    }
                }
                else if (menusList.DisplayName == "DEMOGRAPHICS" && menusList.isDefaultLevel) {
                    if (availableItems.Demographics == "Multiple") {
                        applyToChild(menusList, ["isSingle"], false);
                    }
                    menusList.data.filter(function (e) { return e.DisplayName == "Column" })[0].isDisabled = (selectedColumn == "Demographics" ? false : true);
                    menusList.data.filter(function (e) { return e.DisplayName == "Row" })[0].isDisabled = (selectedRow == "Demographics" ? false : true);
                    menusList.data.filter(function (e) { return e.DisplayName == "Row Nesting" })[0].isDisabled = (selectedRowNesting == "Demographics" ? false : true);
                }

                if (availableItems.Occasion == "Disabled")
                    scope.LeftStaticMenu.filter(function (e) { return e.DisplayName == "OCCASION" })[0].isDisabled = true;

                if (availableItems.Category == "Disabled")
                    scope.LeftStaticMenu.filter(function (e) { return e.DisplayName == "CATEGORY/ITEM/BRAND" })[0].isDisabled = true;

                if (availableItems.Metric == "Disabled")
                    scope.LeftStaticMenu.filter(function (e) { return e.DisplayName == "5Ws" })[0].isDisabled = true;

                if (availableItems.Demographics == "Disabled")
                    scope.LeftStaticMenu.filter(function (e) { return e.DisplayName == "DEMOGRAPHICS" })[0].isDisabled = true;
            }

            return true;
        }

        //let updateChildDetails = function (first, second)
        //{
        //    if (second.length == 0) {
        //        return first;
        //    }
        //    let result = []
        //    for (let item in first) {
        //        if (second.filter(e => e.FilterID == first[item].FilterID).length > 0) {
        //            first[item].data = updateChildDetails(first[item].data, second.filter(e => e.FilterID == first[item].FilterID)[0].Data);
        //            result.push(first[item])
        //        }
        //    }
        //    return result;
        //}
        let updateChildDetails = function (first, second, compare) {
            if (second.length == 0) {
                return first;
            }
            let result = [];
            let indexChecked = [];
            for (let item in first) {
                console.log(first[item]);

                if (indexChecked.findIndex(e => e == item) != -1) {
                    continue;
                }

                if (compare==undefined && second.filter(e => e.FilterID == first[item].FilterID).length > 0) {
                    indexChecked.push(item);
                    first[item].data = updateChildDetails(first[item].data, second.filter(e => e.FilterID == first[item].FilterID)[0].Data);

                    result.push(first[item])
                    if (first[item].IsCollapsible == true) {
                        for (let childItem in first) {
                            if (indexChecked.findIndex(e => e == childItem) != -1) {
                                continue;
                            }

                            if (first[childItem].ParentId == first[item].FilterID) {
                                indexChecked.push(childItem);
                                result.push(first[childItem])
                            }
                        }
                    }



                }
                else if (compare == "DisplayName" && second.filter(e => e.DisplayName == first[item].DisplayName).length > 0) {
                    indexChecked.push(item);
                    first[item].data = updateChildDetails(first[item].data, second.filter(e => e.DisplayName == first[item].DisplayName)[0].Data, compare);

                    result.push(first[item])
                    if (first[item].IsCollapsible == true) {
                        for (let childItem in first) {
                            if (indexChecked.findIndex(e => e == childItem) != -1) {
                                continue;
                            }

                            if (first[childItem].MetricParentName == first[item].DisplayName) {
                                indexChecked.push(childItem);
                                result.push(first[childItem])
                            }
                        }
                    }
                }
            }
            return result;
        }






        //function to select left panel tab
        $scope.menu_Tab_Click = function (menusList, parentList, scope, flag) {
            if (menusList.isDefaultLevel && !menusList.hasChild) {
                return;
            }
            let prevHasChildSelected = menusList.hasChildSelected;
            let prevHasSubMenusActive = menusList.hasSubMenusActive;
            let prevIsTabSelected = menusList.isTabSelected;

            /*check session start*/
            //$.ajax({
            //    async: true,
            //    type: callsType.Post,
            //    url: services.SessionCheckDynamic,
            //    contentType: "application/json; charset=utf-8",
            //    dataType: "json",
            //    success: function (response) {
            //        if (!response) {
            //            $(".logoutLbl").click();
            //            return false;
            //        }
            //    },
            //    error: function (xhr, status, error) {
            //        $(".logoutLbl").click();
            //        return false;
            //    }
            //});
            /*check session end*/

            //Select All functionality start
            $scope.clickOnSelectAll(menusList, parentList);
            //Select All functionality end

            if (menusList.isDefaultLevel) {
                if (!requiredValidations(menusList, parentList))
                    return false;
            }

            if (!menusList.isDefaultLevel && (parentList[0].DisplayName == "DEMOGRAPHICS" || parentList[0].DisplayName == "CATEGORY/ITEM/BRAND" || parentList[0].DisplayName == "ADDITIONAL FILTERS" || parentList[0].DisplayName == "5Ws")) {
                if (!validateRowColumn(menusList, parentList, parentList[0].DisplayName))
                    return false;
            }
            if (menusList.DisplayName == "Custom Filters" && !menusList.data.some(function (e) { return e.hasChildSelected }))
                menusList.data = [];
            if (menusList.data.length == 0 && !menusList.IsLastLevel) {
                let status = $scope.bindingLeftPanelDynamically(menusList, parentList);
                if (!status)
                    return false;
                $scope.UlHeight = angular.element(".left-panel-load.firstleftPanel").css("height");

                /*temporarily disable metrics from left panel start*/
                //if (parentList[0].DisplayName == "MARKETS") {
                //    menusList.data.filter(function (e) { return e.DisplayName == "Latin America" })[0].data.filter(function (e) { return e.DisplayName == "Mexico" })[0].isDisabled = true;
                //}
                /*temporarily disable metrics from left panel end*/
            }

            if (menusList.isDefaultLevel) {
                angular.forEach(scope.LeftStaticMenu, function (value, index) {
                    value.hasSubMenusActive = false;
                    value.isTabSelected = false;
                });
                $scope.DisableAdditionalFiltersTab(menusList, parentList);
            }
            else if (menusList.isSingle && !menusList.hasChildSelected) {
                $scope.singleSelectClick(menusList, parentList);
                if (!parentList[parentList.length - 2].data.some(function (e) { return e.hasChildSelected })) {
                    parentList[parentList.length - 2].hasChildSelected = false;
                }
            }
            else if (!menusList.isDefaultLevel) {
                angular.forEach(parentList[parentList.length - 2].data, function (value, index) {
                    if (value.DisplayName != menusList.DisplayName) {
                        if ((!value.hasChildSelected) && !(value.IsSelectable && !value.IsLastLevel && $scope.hasChildSelected(value)) && !(!value.IsSelectable && !value.IsLastLevel && $scope.hasChildSelected(value))) {
                            value.hasSubMenusActive = false;
                            //value.hasChildSelected = false;
                        }
                        value.isTabSelected = false;
                    }
                    else if (value.ParentId == menusList.ParentId) {
                        if (!value.IsLastLevel && (value.hasChildSelected || (value.IsSelectable && $scope.hasChildSelected(value)) || (!value.IsSelectable && $scope.hasChildSelected(value)))) {
                            menusList.hasSubMenusActive = !menusList.hasSubMenusActive;
                        }
                        menusList.hasSubMenusActive = !menusList.hasSubMenusActive;
                        menusList.isTabSelected = !menusList.isTabSelected;
                        if (!menusList.hasSubMenusActive)
                            menusList.isTabSelected = false;
                    }
                });
            }
            if (menusList.isDefaultLevel) {
                menusList.hasSubMenusActive = !prevHasSubMenusActive;
                menusList.isTabSelected = !prevIsTabSelected;
                let list = ["isTabSelected", "hasSubMenusActive"];
                //  applyToChild(menusList, "isTabSelected", false);
                applyToChild(menusList, list, false, "removeIfNotSelected", 1); //for removing sub_menus_active only when the element is not selected @vj
            }
            //end child code

            if (menusList.IsSelectable) {
                let tempObj = angular.copy(menusList);
                tempObj.Sel = "";
                angular.forEach(parentList, function (value, index) {
                    if (index == 0)
                        tempObj.Menu = value.DisplayName;
                    else if (index == 1)
                        tempObj.FirstLevel = value.DisplayName;
                    tempObj.Sel += value.DisplayName + ":-:";
                    if (value.IsSelectable && value.data.length > 0 && !value.isDefaultLevel && flag)
                        value.hasChildSelected = false;
                    else
                        value.hasChildSelected = true;
                });
                if (!menusList.isTabSelected) {//deselecting code
                    menusList.hasChildSelected = false;
                    angular.forEach(parentList.reverse(), function (value, index) {
                        if (index == 0)
                            value.hasChildSelected = false;
                        else {
                            if (!value.data.some(function (e) { return (e.hasChildSelected || $scope.hasChildSelected(e)) && e.IsCollapsible == null }))
                                value.hasChildSelected = false;
                        }
                    });
                    parentList.reverse();
                }

            }
            //else {
            //    if (!menusList.isTabSelected && !menusList.isDefaultLevel) {//deselecting code
            //        deselectingAllChilds(menusList);
            //        menusList.hasSubMenusActive = false;
            //        angular.forEach(parentList.reverse(), function (value, index) {
            //            if (index == 0)
            //                value.hasChildSelected = false;
            //            else {
            //                if (!value.data.some(function (e) { return e.hasChildSelected && e.IsCollapsible == null }))
            //                    value.hasChildSelected = false;
            //            }
            //        });
            //        parentList.reverse();
            //    }
            //}
            if (!menusList.isDefaultLevel) {
                if (scope == undefined) {
                    if (menusList.isSingle)
                        $scope.searchSingleClick(parentList, 0);
                    if (parentList[1].data.length > 0 && !parentList[1].data.some(function (e) { return $scope.hasChildSelected(e) })) {
                        parentList[1].hasChildSelected = false;
                    }
                    angular.forEach(parentList[1].data, function (value, index) {
                        if (value.hasSubMenusActive && value.isSingle) {
                            if (value.DisplayName != parentList[2].DisplayName) {
                                value.hasChildSelected = false;
                                value.isTabSelected = false;
                                value.hasSubMenusActive = false;
                                let list = ["hasChildSelected", "isTabSelected", "hasSubMenusActive"]
                                applyToChild(value, list, false);
                                //applyToChild(value, "isTabSelected", false);
                                //applyToChild(value, "hasSubMenusActive", false);
                            }
                        }
                    });

                    for (var i = parentList.length - 1; i > 0; i--) {
                        let a = parentList[i - 1].data.filter(function (e) { return e.DisplayName == parentList[i].DisplayName })[0];
                        a.data = parentList[i].data;
                        a.hasChildSelected = parentList[i].hasChildSelected;
                        a.hasSubMenusActive = true;
                        a.isTabSelected = true;
                    }
                    let a = $scope.LeftStaticMenu.filter(function (e) { return e.DisplayName == parentList[0].DisplayName });
                    a.data = parentList[0].data;
                    a.hasChildSelected = parentList[0].hasChildSelected;
                }
            }


            /*handling vertical selection on click of brands/cust. vs non cust. start*/
            if (!menusList.IsCollapsible && parentList[parentList.length - 2] != undefined && parentList[parentList.length - 2].data.where(function (e) { return e.IsCollapsible }).length > 0) {
                angular.forEach(parentList[parentList.length - 2].data.where(function (e) { return e.IsCollapsible }), function (a, b) {
                    childList = parentList[parentList.length - 2].data.where(function (e) { return e.IsCollapsible == null && e.ParentId == a.FilterID });
                    a.hasChildSelected = false;
                    if (childList.some(function (e) { return e.hasChildSelected })) {
                        a.hasSubMenusActive = true;
                        a.isTabSelected = true;
                    }
                    else {
                        a.hasSubMenusActive = false;
                        a.isTabSelected = false;
                    }
                })

            }
            /*handling vertical selection on click of brands/cust. vs non cust. end*/

            /*mutually exclusive is selectable at consecutive levels start*/
            let condition = !menusList.isDefaultLevel && (parentList[0].DisplayName == "MARKETS" || parentList[0].DisplayName == "5Ws" || parentList[1].DisplayName == "5Ws");
            $scope.mutuallyExclusiveConsecutiveLevels(menusList, parentList, condition, prevHasChildSelected);
            //if (parentList.length > 2 && parentList[1].DisplayName.indexOf("Category/Item/Brand") > -1 && prevHasChildSelected != menusList.hasChildSelected && !menusList.isDefaultLevel) {
            //    $scope.mutuallyExclusiveChannelRetailers(menusList, parentList, "Category/Item/Brand");
            //}
            /*mutually exclusive is selectable at consecutive levels end*/



            enableDisableTabs(menusList, parentList, $scope);
            if (prevHasChildSelected != menusList.hasChildSelected && !menusList.isDefaultLevel) {
                submitFlag = 0;
                exportFlag = 0;
                angular.element("body > .nicescroll-rails").remove();
                $(".output-container").hide();
                $(".crosstabTableDiv").detach();
                $(".footerContent").hide();
                $(".footerNote").show();
            }
            //clearing all below selections when selections are changed start
            if (prevHasChildSelected != menusList.hasChildSelected && !menusList.isDefaultLevel) {
                let notToBeClearedList = returnNotToBeClearedList(parentList, menusList);
                if (notToBeClearedList.length > 0)
                    $scope.resetSelections(notToBeClearedList);
            }
            //clearing all below selections when selections are changed end

            $scope.DisableBenchmark(menusList, parentList);

            if (menusList.isTabSelected) {
                $timeout(function (e) {
                    if (parentList.length > 2 && parentList[parentList.length - 2].data.filter(function (e) { return e.IsCollapsible }).length > 0)
                        SetScroll($($("li[ng-name='" + replaceWithDouble_SingleCharacters(parentList[0].DisplayName) + "'] li[ng-name='" + replaceWithDouble_SingleCharacters(menusList.DisplayName) + "']").parents("li")[0]).find(" > .internalWrapper> .wrapper > ul"), "#D31245", 0, 0, 0, 0, 3, false)
                    else if (menusList.DisplayName != parentList[0].DisplayName)
                        if ($("li[ng-name='" + replaceWithDouble_SingleCharacters(parentList[0].DisplayName) + "'] li[ng-name='" + replaceWithDouble_SingleCharacters(menusList.DisplayName) + "'] > .internalWrapper> .wrapper > ul").length > 0)
                            SetScroll($("li[ng-name='" + replaceWithDouble_SingleCharacters(parentList[0].DisplayName) + "'] li[ng-name='" + replaceWithDouble_SingleCharacters(menusList.DisplayName) + "'] > .internalWrapper> .wrapper > ul"), "#D31245", 0, 0, 0, 0, 3, false);
                        else {
                            if (parentList.length > 2)
                                SetScroll($("li[ng-name='" + replaceWithDouble_SingleCharacters(parentList[0].DisplayName) + "'] li[ng-name='" + replaceWithDouble_SingleCharacters(parentList[parentList.length - 2].DisplayName) + "']  > .internalWrapper> .wrapper > ul"), "#D31245", 0, 0, 0, 0, 3, false);
                            if (parentList.length > 3)
                                SetScroll($("li[ng-name='" + replaceWithDouble_SingleCharacters(parentList[0].DisplayName) + "'] li[ng-name='" + replaceWithDouble_SingleCharacters(parentList[parentList.length - 3].DisplayName) + "']  > .internalWrapper> .wrapper > ul"), "#D31245", 0, 0, 0, 0, 3, false);
                        }
                    else
                        SetScroll($("li[ng-name='" + replaceWithDouble_SingleCharacters(parentList[0].DisplayName) + "'] > .internalWrapper > .wrapper > ul"), "#D31245", 0, 0, 0, 0, 3, false);
                })
            }
        }

        //function to open child level of selected tab
        $scope.next_Level_Click = function (menusList, parentList, scope) {
            /*check session start*/
            //$.ajax({
            //    async: true,
            //    type: callsType.Post,
            //    url: services.SessionCheckDynamic,
            //    contentType: "application/json; charset=utf-8",
            //    dataType: "json",
            //    success: function (response) {
            //        if (!response) {
            //            $(".logoutLbl").click();
            //            return false;
            //        }
            //    },
            //    error: function (xhr, status, error) {
            //        $(".logoutLbl").click();
            //        return false;
            //    }
            //});
            /*check session end*/

            if (!menusList.isDefaultLevel && (parentList[0].DisplayName == "DEMOGRAPHICS" || parentList[0].DisplayName == "CATEGORY/ITEM/BRAND" || parentList[0].DisplayName == "ADDITIONAL FILTERS" || parentList[0].DisplayName == "5Ws")) {
                if (!validateRowColumn(menusList, parentList, parentList[0].DisplayName))
                    return false;
            }
            if (menusList.DisplayName == "Custom Filters" && !menusList.data.some(function (e) { return e.hasChildSelected }))
                menusList.data = [];
            if (menusList.data.length == 0 && !menusList.IsLastLevel) {
                let status = $scope.bindingLeftPanelDynamically(menusList, parentList);
                if (!status)
                    return false;
                $scope.UlHeight = angular.element(".left-panel-load.firstleftPanel").css("height");

                /*temporarily disable metrics from left panel start*/

                //if (selectedItems.filter(function (e) { return e.DisplayName == "MARKETS" }).length > 0 && (parentList[0].DisplayName == "5Ws" || (parentList.length > 1 && parentList[1].DisplayName == "5Ws"))) {
                //    var selectedMarkets = $scope.getPKsAndName(selectedItems.filter(function (e) { return e.DisplayName == "MARKETS" })[0].Data, []).select("DisplayName");
                //    if (menusList.data.filter(function (e) { return e.DisplayName == "When" }).length > 0 && menusList.data.filter(function (e) { return e.DisplayName == "When" })[0].data.filter(function (e) { return e.DisplayName == "Day of Week" }).length > 0) {
                //        menusList.data.filter(function (e) { return e.DisplayName == "When" })[0].data.filter(function (e) { return e.DisplayName == "Day of Week" })[0].isDisabled = false;
                //        if (selectedMarkets.indexOf("Europe") > -1 || selectedMarkets.indexOf("UK") > -1 || selectedMarkets.indexOf("France") > -1) {
                //            menusList.data.filter(function (e) { return e.DisplayName == "When" })[0].data.filter(function (e) { return e.DisplayName == "Day of Week" })[0].isDisabled = true;
                //        }
                //    }
                //}
                /*temporarily disable metrics from left panel end*/
            }
            if (menusList.isSingle && !menusList.hasChildSelected) {
                $scope.singleSelectClick(menusList, parentList);
                if (!parentList[parentList.length - 2].data.some(function (e) { return e.hasChildSelected })) {
                    parentList[parentList.length - 2].hasChildSelected = false;
                }
            }
            else if (!menusList.isDefaultLevel) {
                angular.forEach(parentList[parentList.length - 2].data, function (value, index) {
                    if (value.DisplayName != menusList.DisplayName) {
                        if ((!value.hasChildSelected) && !(value.IsSelectable && !value.IsLastLevel && $scope.hasChildSelected(value)) && !(!value.IsSelectable && !value.IsLastLevel && $scope.hasChildSelected(value))) {
                            value.hasSubMenusActive = false;
                            //value.hasChildSelected = false;
                        }
                        value.isTabSelected = false;
                    }
                    else if (value.ParentId == menusList.ParentId) {
                        if (!value.IsLastLevel && (value.hasChildSelected || (value.IsSelectable && $scope.hasChildSelected(value)) || (!value.IsSelectable && $scope.hasChildSelected(value)))) {
                            menusList.hasSubMenusActive = !menusList.hasSubMenusActive;
                        }
                        menusList.hasSubMenusActive = !menusList.hasSubMenusActive;
                        menusList.isTabSelected = !menusList.isTabSelected;
                        if (!menusList.hasSubMenusActive)
                            menusList.isTabSelected = false;
                    }
                });
            }
            if (menusList.data.filter(function (e) { return e.IsCollapsible }).length > 0) {
                angular.forEach(menusList.data, function (a, b) {
                    if (!a.IsCollapsible)
                        a.IsHidden = true;
                    else
                        a.IsExpanded = false;
                })
            }
            //if (parentList[0].DisplayName.toUpperCase() == '5WS' || parentList[1].DisplayName.toUpperCase() == '5WS')
            //    $scope.hasSelectAll(menusList, parentList);

            /*handling vertical selection on click of brands/cust. vs non cust. start*/
            if (!menusList.IsCollapsible && menusList.data.where(function (e) { return e.IsCollapsible }).length > 0) {
                angular.forEach(menusList.data.where(function (e) { return e.IsCollapsible }), function (a, b) {
                    childList = menusList.data.where(function (e) { return e.IsCollapsible == null && e.ParentId == a.FilterID });
                    a.hasChildSelected = false;
                    if (childList.some(function (e) { return e.hasChildSelected })) {
                        a.hasSubMenusActive = true;
                        a.isTabSelected = true;
                    }
                    else {
                        a.hasSubMenusActive = false;
                        a.isTabSelected = false;
                    }
                })

            }
            /*handling vertical selection on click of brands/cust. vs non cust. end*/

            if (!menusList.isDefaultLevel && (menusList.IsSelectable || menusList.isSingle)) {
                selectedItems = $scope.getSelectedItems($scope.LeftStaticMenu.filter(function (e) { return e.hasChild }));
                List = [];
                List.push(parentList[0]);
                $scope.updateLeftMenuSelections(selectedItems, List);

                var selContent = $scope.formSelectionSummary(selectedItems, leftPanel_Parents.filter(function (e) { return e.hasChild }));
                angular.element(document.querySelectorAll(".summay-content-text > div")).html(selContent);
            }
            if (menusList.isGroupNeeded && menusList.isTabSelected) {
                $scope.addCustomGroup(menusList, parentList)
            }
            if (menusList.isTabSelected) {
                $timeout(function (e) {
                    if (menusList.DisplayName != parentList[0].DisplayName)
                        SetScroll($("li[ng-name='" + replaceWithDouble_SingleCharacters(parentList[0].DisplayName) + "'] li[ng-name='" + replaceWithDouble_SingleCharacters(menusList.DisplayName) + "'] > .internalWrapper> .wrapper > ul"), "#D31245", 0, 0, 0, 0, 3, false);
                    else
                        SetScroll($("li[ng-name='" + replaceWithDouble_SingleCharacters(parentList[0].DisplayName) + "'] > .internalWrapper > .wrapper > ul"), "#D31245", 0, 0, 0, 0, 3, false);
                })
            }
        }

        $scope.left_panel_submit = function (type) {
            let footerType = updateFooterPercentageCategory($scope);
            angular.element(document.getElementsByClassName("footerContent")).hide();
            angular.element(document.getElementsByClassName("output-container")).hide();
            angular.element(document.getElementsByClassName("footerNote")).show();
            angular.element(document.querySelectorAll(".selectionButtonCallout")).css("display", "none");
            angular.element(document.querySelectorAll(".calloutArrow")).css("display", "none");
            angular.element(document.getElementsByClassName("save_filter_icon")).addClass("disableSelection");
            angular.element(document.getElementsByClassName("excelDiv")).addClass("disableSelection");
            angular.element(document.getElementsByClassName("pptDiv")).addClass("disableSelection");
            angular.element("body > .nicescroll-rails").remove();
            responseData = [];
            showBackgroundShadow(true, true);
            if (!$scope.leftMenuIsHidden) {
                $scope.leftPanelToggle();
                //   angular.element(document.querySelectorAll(".selectionButtonCallout")).css("display", "none");
                //   angular.element(document.querySelectorAll(".calloutArrow")).css("display", "none");
            }

            if (!$scope.ModuleIsHidden)
                $scope.ModulePanelToggle();

            var List = $scope.LeftStaticMenu.where(function (e) { return e.hasChild });
            List.where(function (e) { return e.hasSubMenusActive = false });
            List.where(function (e) { return e.isTabSelected = false });
            angular.forEach(List, function (a, b) {
                applyToChild(a, ["isTabSelected"], false);
            })
            if (!onSubmitValidations())
                return false;
            CrossTabRequest = returnRequestObject();
            CrossTabRequest.SelectedItems = JSON.stringify(selectedItems);
            CrossTabRequest.PercentageType = (footerType ? "Item%" : "Occasion%");
            CrossTabRequest.PercentageType = (footerType ? "Item%" : "Occasion%");
            $.ajax({
                type: callsType.Post,
                url: services.GetCrossTabData,
                async: true,
                processData: false,
                timeout: 600000,
                data: JSON.stringify(CrossTabRequest),
                contentType: "application/json;charset=utf-8",
                dataType: "json",
                success: function (respdata) {
                    if (respdata == false) {
                        $(".logoutLbl").click();
                        return;
                    }
                    else {
                        responseData = respdata.DataList;
                        exportFlag = 1;// for validating export
                        submitFlag = 1;
                        if (responseData.length > 0) {
                            //angular.element(".view-container").scope().setInitialValue();
                            angular.element(document.querySelectorAll(".selectionButtonCallout")).css("display", "none");
                            angular.element(document.querySelectorAll(".calloutArrow")).css("display", "none");
                            angular.element(document.getElementsByClassName("footerNote")).hide();
                            angular.element(document.getElementsByClassName("footerContent")).show();
                            angular.element(document.getElementsByClassName("output-container")).show();
                            CreateGrid('Percentage', $(".output-container .chartArea"));
                            angular.element(document.getElementsByClassName("excelDiv")).removeClass("disableSelection");
                            let adnList = selectedItems.filter(function (e) { return e.DisplayName == "ADDITIONAL FILTERS" });
                            if (adnList.length > 0 && adnList[0].Data.filter(function (e) { return e.DisplayName == "Custom Filters" }).length == 0)
                                angular.element(document.getElementsByClassName("save_filter_icon")).removeClass("disableSelection");
                            $('#dispTotal').hide();
                            $('#dispLabel').hide();
                            $($('#dispLabel div:last-child')[1]).removeClass('chkbox_active').addClass('chkbox');
                            $($('#dispTotal div:last-child')[1]).removeClass('chkbox').addClass('chkbox_active');
                            angular.element(document.getElementsByClassName("chartIcons")).children().removeClass("active");
                            angular.element(document.getElementsByClassName("tableChart")).addClass("active");
                            //var columns = $.unique(responseData.map(function (d) { return d.ColumnMetricName; }));

                            // vikash
                            var rowNesting = $.unique(responseData.map(function (d) { if (d.NestingMetricName != "") return d.NestingMetricName; }));
                            if (type == 'leftPanel') {
                                $("#lstRespType").multiselect('selectAll', false);
                            }
                            //if row nesting is enabled disable all charts
                            angular.element(document.getElementsByClassName("trendChart")).removeClass("enable");
                            angular.element(document.getElementsByClassName("stackChart")).removeClass("enable");
                            isStackChart = false; isTrendChart = false;
                            if (CrossTabRequest.RowNesting == "") {
                                let obj = getSelectedMainValues();
                                let selectedColumn = obj.Column, selectedRow = obj.Row, selectedRowNesting = obj.RowNesting;
                                let ColumnList = selectedItems.filter(function (e) { return e.DisplayName.toUpperCase().indexOf(selectedColumn.toUpperCase().replace("-MANUFACTURER", "")) > -1 })[0].Data;
                                if (selectedColumn != "Occasion" && selectedColumn != "Market" && selectedColumn != "Time Period")
                                    ColumnList = selectedItems.filter(function (e) { return e.DisplayName.toUpperCase().indexOf(selectedColumn.toUpperCase().replace("-MANUFACTURER", "")) > -1 })[0].Data.filter(function (e) { return e.DisplayName == "Column" })[0].Data;
                                let RowList = selectedItems.filter(function (e) { return e.DisplayName.toUpperCase().indexOf(selectedRow.toUpperCase().replace("-MANUFACTURER", "")) > -1 })[0].Data
                                if (selectedRow != "Occasion" && selectedRow != "Market" && selectedRow != "Time Period")
                                    RowList = selectedItems.filter(function (e) { return e.DisplayName.toUpperCase().indexOf(selectedRow.toUpperCase().replace("-MANUFACTURER", "")) > -1 })[0].Data.filter(function (e) { return e.DisplayName == "Row" })[0].Data;

                                if ($scope.getPKsAndName(ColumnList, []).length < 24 && $scope.getPKsAndName(RowList, []).length < 16) {
                                    angular.element(document.getElementsByClassName("stackChart")).addClass("enable");
                                    isStackChart = true;
                                    //angular.element(document.getElementsByClassName("pptDiv")).removeClass("disableSelection");

                                    //if columns in timeperiod, enable trend chart
                                    if (CrossTabRequest.SelectionSummary.split('||')[0].split(':')[1].trim().toLowerCase() == 'time period') {
                                        angular.element(document.getElementsByClassName("trendChart")).addClass("enable");
                                        isTrendChart = true;
                                    }
                                }
                            }
                            if (sessionStorage.getItem("widgetInfo") != null && sessionStorage.getItem("widgetInfo") != "") {
                                bindWidgetChart();
                            }
                            else
                                showBackgroundShadow(false, false);
                        }
                        else {
                            show_popup("Alert", customMessages.DataNotAvailable);
                            angular.element(document.getElementsByClassName("footerContent")).hide();
                            angular.element(document.getElementsByClassName("footerNote")).show();
                            angular.element(document.querySelectorAll(".selectionButtonCallout")).css("display", "block");
                            angular.element(document.querySelectorAll(".calloutArrow")).css("display", "block");
                            angular.element(document.getElementsByClassName("save_filter_icon")).addClass("disableSelection");
                            //angular.element(document.getElementsByClassName("output-container")).hide();
                            return false;
                        }
                    }
                },
                error: function (xhr, status, error) {
                    angular.element(document.getElementsByClassName("footerContent")).hide();
                    angular.element(document.getElementsByClassName("footerNote")).show();
                    //angular.element(document.getElementsByClassName("output-container")).hide();
                    show_popup("Alert", customMessages.Error);
                    return false;
                }
            })
        }

        //function to check if all mandatory selections are made or not
        function onSubmitValidations() {
            if (selectedItems == undefined || selectedItems.length == 0) {
                show_popup("Alert", customMessages.ColumnSelection)
                return false;
            }
            else if (!selectedItems.some(function (e) { return e.DisplayName == "COLUMN" })) {
                show_popup("Alert", customMessages.ColumnSelection)
                return false;
            }
            else if (!selectedItems.some(function (e) { return e.DisplayName == "ROW" })) {
                show_popup("Alert", customMessages.RowSelection)
                return false;
            }
            else if (!selectedItems.some(function (e) { return e.DisplayName == "TIME PERIOD" })) {
                show_popup("Alert", customMessages.Timeperiod)
                return false;
            }
            else if (!selectedItems.some(function (e) { return e.DisplayName == "MARKETS" })) {
                show_popup("Alert", customMessages.MarketSelection)
                return false;
            }
            else {
                curscope = angular.element("#left-pane-container").scope();
                let obj = getSelectedMainValues();
                let selectedRowNesting = obj.RowNesting, selectedRow = obj.Row, selectedColumn = obj.Column;
                let availableItems = scenarios.filter(function (e) { return e.Column == selectedColumn && e.Row == selectedRow && e.RowNesting == selectedRowNesting })[0];
                if (!selectedItems.some(function (e) { return e.DisplayName == "OCCASION" }) && availableItems.Occasion != 'Disabled') {
                    show_popup("Alert", customMessages.OccasionSelection)
                    return false;
                }
                else if (!selectedItems.some(function (e) { return e.DisplayName == "CATEGORY/ITEM/BRAND" }) && availableItems.Category != 'Disabled') {
                    show_popup("Alert", customMessages.CategorySelection)
                    return false;
                }
                else if (!selectedItems.some(function (e) { return e.DisplayName == "5Ws" }) && availableItems.Metric != 'Disabled') {
                    show_popup("Alert", customMessages.MetricSelection)
                    return false;
                }
                else if (!selectedItems.some(function (e) { return e.DisplayName == "DEMOGRAPHICS" }) && availableItems.Demographics != 'Disabled') {
                    show_popup("Alert", customMessages.DemographicSelection)
                    return false;
                }
                else if (availableItems.Category != 'Disabled' && curscope.LeftStaticMenu.filter(function (e) { return e.DisplayName == "CATEGORY/ITEM/BRAND" })[0].data.filter(function (e) { return !e.isDisabled }).length != curscope.LeftStaticMenu.filter(function (e) { return e.DisplayName == "CATEGORY/ITEM/BRAND" })[0].data.filter(function (e) { return curscope.hasChildSelected(e) }).length) {
                    if (!curscope.LeftStaticMenu.filter(function (e) { return e.DisplayName == "CATEGORY/ITEM/BRAND" })[0].data.filter(function (e) { return e.DisplayName == "Row" })[0].isDisabled && !curscope.LeftStaticMenu.filter(function (e) { return e.DisplayName == "CATEGORY/ITEM/BRAND" })[0].data.filter(function (e) { return e.DisplayName == "Row" })[0].hasChildSelected) {
                        show_popup("Alert", customMessages.RowSelection)
                        return false;
                    }
                    else {
                        show_popup("Alert", customMessages.RowNestingSelection)
                        return false;
                    }
                }
                else if (availableItems.Metric != 'Disabled' && curscope.LeftStaticMenu.filter(function (e) { return e.DisplayName == "5Ws" })[0].data.filter(function (e) { return !e.isDisabled }).length != curscope.LeftStaticMenu.filter(function (e) { return e.DisplayName == "5Ws" })[0].data.filter(function (e) { return curscope.hasChildSelected(e) }).length) {
                    if (!curscope.LeftStaticMenu.filter(function (e) { return e.DisplayName == "5Ws" })[0].data.filter(function (e) { return e.DisplayName == "Row" })[0].isDisabled && !curscope.LeftStaticMenu.filter(function (e) { return e.DisplayName == "5Ws" })[0].data.filter(function (e) { return e.DisplayName == "Row" })[0].hasChildSelected) {
                        show_popup("Alert", customMessages.RowSelection)
                        return false;
                    }
                    else {
                        show_popup("Alert", customMessages.RowNestingSelection)
                        return false;
                    }
                }
                else if (availableItems.Demographics != 'Disabled' && curscope.LeftStaticMenu.filter(function (e) { return e.DisplayName == "DEMOGRAPHICS" })[0].data.filter(function (e) { return !e.isDisabled }).length != curscope.LeftStaticMenu.filter(function (e) { return e.DisplayName == "DEMOGRAPHICS" })[0].data.filter(function (e) { return curscope.hasChildSelected(e) }).length) {
                    if (!curscope.LeftStaticMenu.filter(function (e) { return e.DisplayName == "DEMOGRAPHICS" })[0].data.filter(function (e) { return e.DisplayName == "Row" })[0].isDisabled && !curscope.LeftStaticMenu.filter(function (e) { return e.DisplayName == "DEMOGRAPHICS" })[0].data.filter(function (e) { return e.DisplayName == "Row" })[0].hasChildSelected) {
                        show_popup("Alert", customMessages.RowSelection)
                        return false;
                    }
                    else {
                        show_popup("Alert", customMessages.RowNestingSelection)
                        return false;
                    }
                }
            }
            return true;
        }

        //function to return tabs which are not to be cleared
        function returnNotToBeClearedList(parentList, menusList) {
            let List = [];
            if (parentList[0].DisplayName == "COLUMN" && menusList.DisplayName != "COLUMN")
                List = ["TABLE STRUCTURE", "TABLE CONTENT", "COLUMN"];
            else if (parentList[0].DisplayName == "ROW" && menusList.DisplayName != "ROW")
                List = ["TABLE STRUCTURE", "TABLE CONTENT", "COLUMN", "ROW"];
            else if (parentList[0].DisplayName == "ROW NESTING" && menusList.DisplayName != "ROW NESTING")
                List = ["TABLE STRUCTURE", "TABLE CONTENT", "COLUMN", "ROW", "ROW NESTING"];
            else if (parentList[0].DisplayName == "TIME PERIOD" && menusList.DisplayName != "TIME PERIOD")
                List = ["TABLE STRUCTURE", "TABLE CONTENT", "COLUMN", "ROW", "ROW NESTING", "TIME PERIOD", "BENCHMARK"];
            else if (parentList[0].DisplayName == "MARKETS" && menusList.DisplayName != "MARKETS")
                List = ["TABLE STRUCTURE", "TABLE CONTENT", "COLUMN", "ROW", "ROW NESTING", "TIME PERIOD", "MARKETS", "BENCHMARK"];
            else if (parentList[0].DisplayName == "OCCASION" && menusList.DisplayName != "OCCASION")
                List = ["TABLE STRUCTURE", "TABLE CONTENT", "COLUMN", "ROW", "ROW NESTING", "TIME PERIOD", "MARKETS", "OCCASION", "BENCHMARK"];
            else if (parentList[0].DisplayName == "CATEGORY/ITEM/BRAND" && menusList.DisplayName != "CATEGORY/ITEM/BRAND")
                List = ["TABLE STRUCTURE", "TABLE CONTENT", "COLUMN", "ROW", "ROW NESTING", "TIME PERIOD", "MARKETS", "OCCASION", "CATEGORY/ITEM/BRAND", "BENCHMARK"];
            else if (parentList[0].DisplayName == "5Ws" && menusList.DisplayName != "5Ws")
                List = ["TABLE STRUCTURE", "TABLE CONTENT", "COLUMN", "ROW", "ROW NESTING", "TIME PERIOD", "MARKETS", "OCCASION", "CATEGORY/ITEM/BRAND", "5Ws", "BENCHMARK"];
            else if (parentList[0].DisplayName == "DEMOGRAPHICS" && menusList.DisplayName != "DEMOGRAPHICS")
                List = ["TABLE STRUCTURE", "TABLE CONTENT", "COLUMN", "ROW", "ROW NESTING", "TIME PERIOD", "MARKETS", "OCCASION", "CATEGORY/ITEM/BRAND", "5Ws", "DEMOGRAPHICS", "BENCHMARK"];


            return List;
        }

        $scope.hasSearch = function (menusList, parent_list) {
            var searchList = searchSelectAllList.filter(function (e) { return e.Search }).select("DisplayName").distinct();
            if (searchList.indexOf(menusList.DisplayName) > -1 && !(menusList.DisplayName == "5Ws" && menusList.isDefaultLevel)) {
                $scope.crosstabLeftPanel = false;
                return true;
            }
            $scope.crosstabLeftPanel = true;
            return false;
        }

        function validateRowColumn(menusList, parentList, parent) {
            if (parentList[0].DisplayName == parent && parentList[parentList.length - 2].DisplayName == parent) {
                var enabledList = parentList[parentList.length - 2].data.filter(function (e) { return !e.isDisabled }).select("DisplayName");
                if (enabledList.indexOf("Column") > -1 && menusList.DisplayName.toUpperCase() != "COLUMN" && selectedItems.filter(function (e) { return e.DisplayName == parent }).length == 0) {
                    show_popup("Alert", customMessages.ColumnSelection);
                    return false;
                }
                else if (enabledList.indexOf("Row") > -1 && menusList.DisplayName.toUpperCase() != "ROW" && menusList.DisplayName.toUpperCase() != "COLUMN" && (selectedItems.filter(function (e) { return e.DisplayName == parent }).length == 0 || selectedItems.filter(function (e) { return e.DisplayName == parent })[0].Data.filter(function (e) { return e.DisplayName == "Row" }).length == 0)) {
                    show_popup("Alert", customMessages.RowSelection);
                    return false;
                }
            }
            let index = 0;
            if (!menusList.isDefaultLevel && parentList[0].DisplayName == parent && parentList.length > 2) {
                if (menusList.IsSelectable && (parentList.select("DisplayName").indexOf("Column") > -1 || parentList.select("DisplayName").indexOf("Category") > -1)) {
                    if (parentList.select("DisplayName").indexOf("Category") > -1)
                        index = 1;

                    angular.forEach(parentList[index].data, function (a, b) {
                        if (b > 0) {
                            parentList[index].data[b].data = [];
                            parentList[index].data[b].hasChildSelected = false;
                            parentList[index].data[b].hasSubMenusActive = false;
                            parentList[index].data[b].isTabSelected = false;
                        }
                    })
                }
                else if (menusList.IsSelectable && (parentList.select("DisplayName").indexOf("Row") > -1 || parentList.select("DisplayName").indexOf("Item") > -1)) {
                    if (parentList.select("DisplayName").indexOf("Item") > -1)
                        index = 1;
                    angular.forEach(parentList[index].data, function (a, b) {
                        if (b > 1) {
                            parentList[index].data[b].data = [];
                            parentList[index].data[b].hasChildSelected = false;
                            parentList[index].data[b].hasSubMenusActive = false;
                            parentList[index].data[b].isTabSelected = false;
                        }
                    })
                }
            }
            return true;
        }

        function modifyData(menusList, parent, actualData) {
            let removeList = [];
            let dataList = selectedItems.filter(function (e) { return e.DisplayName == parent });
            if (dataList.length > 0) {
                let columnDataList = dataList[0].Data.filter(function (e) { return e.DisplayName == "Column" });
                if (menusList.DisplayName == "Row" && columnDataList.length > 0) {
                    removeList = columnDataList[0].Data.filter(function (e) { return e.DisplayName != "Consumer Typologies" }).select("DisplayName");
                    menusList.data = actualData.filter(function (e) { return removeList.indexOf(e.DisplayName) == -1 });
                    if (columnDataList[0].Data.filter(function (e) { return e.DisplayName == "Consumer Typologies" }).length > 0) {
                        let rmlist = columnDataList[0].Data.filter(function (e) { return e.DisplayName == "Consumer Typologies" })[0].Data.select("DisplayName");
                        if (menusList.data.filter(function (e) { return e.DisplayName == "Consumer Typologies" }).length > 0) {
                            let typoData = menusList.data.filter(function (e) { return e.DisplayName == "Consumer Typologies" })[0].data;
                            menusList.data.filter(function (e) { return e.DisplayName == "Consumer Typologies" })[0].data = typoData.filter(function (e) { return rmlist.indexOf(e.DisplayName) == -1 });
                        }
                    }
                }
                else {
                    let rmlist = [];
                    let rowDataList = dataList[0].Data.filter(function (e) { return e.DisplayName == "Row" });
                    if (columnDataList.length > 0 && menusList.DisplayName == "Row Nesting") {
                        removeList = columnDataList[0].Data.filter(function (e) { return e.DisplayName != "Consumer Typologies" }).select("DisplayName");
                        if (columnDataList[0].Data.filter(function (e) { return e.DisplayName == "Consumer Typologies" }).length > 0) {
                            rmlist = columnDataList[0].Data.filter(function (e) { return e.DisplayName == "Consumer Typologies" })[0].Data.select("DisplayName");
                        }
                    }
                    if (rowDataList.length > 0 && menusList.DisplayName == "Row Nesting") {
                        removeList = removeList.concat(rowDataList[0].Data.filter(function (e) { return e.DisplayName != "Consumer Typologies" }).select("DisplayName"));
                        if (rowDataList[0].Data.filter(function (e) { return e.DisplayName == "Consumer Typologies" }).length > 0) {
                            rmlist = rmlist.concat(rowDataList[0].Data.filter(function (e) { return e.DisplayName == "Consumer Typologies" })[0].Data.select("DisplayName"));
                        }
                    }
                    //if (menusList.Filter == "ADDITIONAL FILTERS") {
                    //    let rowNestingDataList = dataList[0].Data.filter(function (e) { return e.DisplayName == "Row Nesting" });
                    //    if (rowNestingDataList.length > 0)
                    //        removeList = removeList.concat(rowNestingDataList[0].Data.select("DisplayName"));
                    //}
                    menusList.data = actualData.filter(function (e) { return removeList.indexOf(e.DisplayName) == -1 });
                    if (menusList.data.filter(function (e) { return e.DisplayName == "Consumer Typologies" }).length > 0) {
                        let typoData = menusList.data.filter(function (e) { return e.DisplayName == "Consumer Typologies" })[0].data;
                        menusList.data.filter(function (e) { return e.DisplayName == "Consumer Typologies" })[0].data = typoData.filter(function (e) { return rmlist.indexOf(e.DisplayName) == -1 });
                    }
                }
            }
            else {
                menusList.data = actualData;
            }
        }

        // creating the request Obj for output start
        function returnRequestObject() {
            var request = {};
            var respObj = getRespType();
            request.Columns = "";
            request.Rows = "";
            request.RowNesting = "";
            request.TimePeriod = "";
            request.Market = "";
            request.AdlFilters = "";
            request.Significance = "";
            request.RespType = respObj.respId;
            let index = $(".summay-content-text .middleAlign").html().indexOf(" || <span>RESPONDENT TYPE");
            let inhtml = $(".summay-content-text .middleAlign").html();
            if (index > -1) {
                inhtml = inhtml.substring(0, index);
            }
            $(".summay-content-text .middleAlign").html(inhtml + " || <span>RESPONDENT TYPE: </span>" + respObj.respName);
            request.SelectionSummary = $(".summay-content-text").text().trim();

            let obj = getSelectedMainValues();
            let selectedColumn = obj.Column;
            let selectedRow = obj.Row;
            let selectedRowNesting = obj.RowNesting;

            /*get column selections start*/
            let columnSelections = selectedItems.filter(function (e) { return e.DisplayName.toUpperCase().indexOf(selectedColumn.toUpperCase().replace("-MANUFACTURER", "")) > -1 });
            if (selectedColumn != "Occasion" && selectedColumn != "Time Period" && selectedColumn != "Market")
                columnSelections = columnSelections[0].Data.filter(function (e) { return e.DisplayName == "Column" });
            else if (selectedColumn != "Occasion")
                request.Columns = selectedColumn.replace(" ", '') + "|"
            request.Columns += $scope.getPKsAndName(columnSelections, []).select("FilterID").join(",");
            /*get column selections end*/

            /*get row selections start*/
            let rowSelections = selectedItems.filter(function (e) { return e.DisplayName.toUpperCase().indexOf(selectedRow.toUpperCase().replace("-MANUFACTURER", "")) > -1 });
            if (selectedRow != "Occasion" && selectedRow != "Time Period" && selectedRow != "Market")
                rowSelections = rowSelections[0].Data.filter(function (e) { return e.DisplayName == "Row" });
            else if (selectedRow != "Occasion")
                request.Rows = selectedRow.replace(" ", '') + "|"
            request.Rows += $scope.getPKsAndName(rowSelections, []).select("FilterID").join(",");
            /*get row selections end*/

            /*get row nesting selections start*/
            let rowNestingSelections = selectedItems.filter(function (e) { return e.DisplayName.toUpperCase().indexOf(selectedRowNesting.toUpperCase().replace("-MANUFACTURER", "")) > -1 });
            if (selectedRowNesting != "Occasion" && selectedRowNesting != "Time Period" && selectedRowNesting != "Market")
                rowNestingSelections = rowNestingSelections[0].Data.filter(function (e) { return e.DisplayName == "Row Nesting" });
            else if (selectedRowNesting != "Occasion")
                request.RowNesting = selectedRowNesting.replace(" ", '') + "|"
            request.RowNesting += $scope.getPKsAndName(rowNestingSelections, []).select("FilterID").join(",");
            /*get row nesting selections end*/

            /*get time period selections start*/
            if (selectedColumn != "Time Period" && selectedRow != "Time Period" && selectedRowNesting != "Time Period") {
                let timeperiodSelections = selectedItems.filter(function (e) { return e.DisplayName == "TIME PERIOD" });
                request.TimePeriod = $scope.getPKsAndName(timeperiodSelections, []).select("FilterID").join(",");
            }
            /*get time period selections end*/

            /*get market selections start*/
            if (selectedColumn != "Market" && selectedRow != "Market" && selectedRowNesting != "Market") {
                let marketSelections = selectedItems.filter(function (e) { return e.DisplayName == "MARKETS" });
                if (marketSelections[0].Data[0].DisplayName != "Select All Markets")
                    request.Market = $scope.getPKsAndName(marketSelections, []).select("FilterID").join(",");
                else
                    request.Market = MarketRegionList.filter(function (e) { return !e.isDisabled }).select("FilterID").join(',');
            }
            /*get market selections end*/

            /*get additional filter selections start*/
            request.AdlFilters = $scope.AdditionalFilterRequest().FilterID;
            /*get additional filter selections end*/

            /*get benchmark selections start*/
            if (selectedItems.filter(function (e) { return e.DisplayName == "BENCHMARK" }).length > 0) {
                let benchmarkSelections = selectedItems.filter(function (e) { return e.DisplayName == "BENCHMARK" });
                request.Significance = $scope.getPKsAndName(benchmarkSelections, []).select("FilterID").join(",");
            }
            /*get benchmark selections end*/

            return request;
        }

        function getRespType() {
            /*get respondent type start*/
            //request.RespType = angular.element(".headerDropdownBox .active").attr("respId");
            var selected = $("#lstRespType option:selected");
            var message = "", respname = "";
            if (angular.element(".leftpanelarea").is(":visible")) {
                $("#lstRespType").multiselect('selectAll', false);
                $("#lstRespType").multiselect('updateButtonText', true);
            } else
                selected.each(function () {
                    message += $(this).val() + ",";
                    respname += $(this).text().trim() + ', '
                });

            return { "respId": (message === "" ? "1,2,3" : message.substring(0, message.length - 1)), "respName": (respname === "" ? "Adult(18 - 70 yrs), Teen(13 - 17 yrs), Kids(4 -12 yrs)" : respname.substring(0, respname.length - 2)) };
            /*get respondent type end*/
        }

        CommonLeftPanelFunction($scope, commonService, $http, $sce, $timeout, $compile);
    }])

    .directive("ngVdata", function () {
        return {
            link: function (scope) {
                scope.curScope = scope;
            },
            templateUrl: function () {
                return "/AngularTemplates/LeftPanel.html?version=" + version;
            }
        }
    })
    .filter("search", function () {
        return function (listItem, args) {
            return searchFilter(listItem, args)
        }
    })

//function to set property at all levels
//function applyToChild(menusList, item, newVal, parentValue) {
//    if (menusList.data != undefined && menusList.data.length > 0) {
//        angular.forEach(menusList.data.filter(function (e) { return !e.isDisabled }), function (value, index) {
//            if (value[item] || parentValue != undefined) {
//                if (value.data.length > 0)
//                    applyToChild(value, item, newVal, parentValue);
//                value[item] = newVal;
//                if (parentValue == "removeIfNotSelected" && (value.hasChildSelected || value.data.some(function (e) { return e.hasChildSelected }))) { //@vj
//                    value[item] = true;
//                }
//            }
//            else {
//                value[item] = newVal;
//                if (value.data.length > 0)
//                    applyToChild(value, item, newVal, parentValue);
//            }
//        })
//    }
//}

function applyToChild(menusList, itemList, newVal, parentValue, ind) {
    if (menusList.data != undefined && menusList.data.length > 0) {
        angular.forEach(menusList.data.filter(function (e) { return !e.isDisabled }), function (value, index) {
            for (var i in itemList) {
                value[itemList[i]] = newVal;
            }
            if (value.data.length > 0)
                applyToChild(value, itemList, newVal, parentValue, ind);

            if (parentValue != undefined) {

                if (parentValue == "removeIfNotSelected" && (value.hasChildSelected || value.data.some(function (e) { return e.hasChildSelected }))) { //@vj
                    value[itemList[ind]] = true;
                }
            }

        })
    }
}

var isStackChart = false; var isTable = false; var isTrendChart = false;
//function to switch between tabular view, stack and trend chart
function selectChartType($event, isTrend) {
    showBackgroundShadow(true, true);
    if ($event != undefined) {
        angular.element($event.target).parents(".chartIcons").children().removeClass("active");
        if (angular.element($event.target.parentElement).hasClass("chartIcons"))
            angular.element($event.target).addClass("active");
        else
            angular.element($event.target.parentElement.parentElement).addClass("active");

        var className = $event.target.className;
        //}
        //else {
        //    var className = angular.element(".chartIcons .active").attr("class");
        //}

        if (className.indexOf("table") !== -1) {
            $('#dispTotal').hide();
            $('#dispLabel').hide();
            $('.excelDiv').removeClass('disableSelection')
            $('.pptDiv').addClass('disableSelection')
            CreateGrid('Percentage', $(".output-container .chartArea"));
        } else {
            $('.excelDiv').addClass('disableSelection')
            $('.pptDiv').removeClass('disableSelection')
            angular.element("body > .nicescroll-rails").remove();
            responseData.filter(function (e) { return e.RowMetricName = e.RowMetricName.replace(/£/gi, "&pound;").trim() });//pound symbol not rendering in charts because of encoding
            if (!isTrend && isStackChart) {
                //ajax call get chart data
                $('#dispTotal').show();
                $('#dispLabel').show();
                $.ajax({
                    type: callsType.Post,
                    url: services.GetChartData,
                    async: true,
                    data: "{'responseData': '" + escape(JSON.stringify(responseData)) + "', 'showTotal': " + $($('#dispTotal div:last-child')[1]).hasClass('chkbox_active') + " }",
                    contentType: "application/json;charset=utf-8",
                    dataType: "json",
                    success: function (respdata) {
                        //debugger;
                        if (respdata == false) {
                            $(".logoutLbl").click();
                            return;
                        }
                        else {
                            stackChartData = respdata;
                            plot_stack_chart(respdata, false, "", true, $($('#dispLabel div:last-child')[1]).hasClass('chkbox_active'));
                        }
                    },
                    error: function (xhr, status, error) {
                        angular.element(document.getElementsByClassName("footerContent")).hide();
                        angular.element(document.getElementsByClassName("footerNote")).show();
                        //angular.element(document.getElementsByClassName("output-container")).hide();
                        show_popup("Alert", customMessages.Error);
                        return false;
                    }
                });
            }
            else if (isTrend && isTrendChart) {
                //ajax call get chart data
                $('#dispTotal').hide();
                $('#dispLabel').show();
                $.ajax({
                    type: callsType.Post,
                    url: services.GetChartData,
                    async: true,
                    data: "{'responseData': '" + escape(JSON.stringify(responseData)) + "', 'showTotal': 'false' }",
                    contentType: "application/json;charset=utf-8",
                    dataType: "json",
                    success: function (respdata) {
                        //debugger;
                        if (respdata == false) {
                            $(".logoutLbl").click();
                            return;
                        }
                        else {
                            stackChartData = respdata;
                            plot_trend_chart(respdata, false, "", true, $($('#dispLabel div:last-child')[1]).hasClass('chkbox_active'));
                        }
                    },
                    error: function (xhr, status, error) {
                        angular.element(document.getElementsByClassName("footerContent")).hide();
                        angular.element(document.getElementsByClassName("footerNote")).show();
                        //angular.element(document.getElementsByClassName("output-container")).hide();
                        show_popup("Alert", customMessages.Error);
                        return false;
                    }
                });
            }
        }
    }
    showBackgroundShadow(false, false);
}

//function to select respondent type
function selectRespType($event) {
    angular.element($event.currentTarget.parentElement).children().removeClass("active");
    angular.element($event.currentTarget).addClass("active");
    angular.element(".headerDropdown > .dropdownText > .middleAlign").text(angular.element($event.currentTarget).text());
    let curscope = angular.element("#left-pane-container").scope();
    curscope.left_panel_submit();
}

//function to toggle respondent type dropdown
function headerDropdownToggle() {
    if (submitFlag) {
        if (angular.element(".headerDropdownBox").is(":visible"))
            angular.element(".headerDropdownBox").hide();
        else
            angular.element(".headerDropdownBox").show();
    }
    else {
        show_popup("Alert", "Please click on submit and try again, as the selection has been changed.");
        return;
    }
}

//function to switch between weighted and unweighted sample
function selectSampleType($event) {
    if (!angular.element($event.currentTarget).hasClass("active")) {//if not already active
        angular.element($event.currentTarget.parentElement).children().removeClass("active");
        angular.element($event.currentTarget).addClass("active");
        CreateGrid(angular.element($event.currentTarget).text().trim().split(" ")[0], $(".samplesize-popup .popup-container"));
    }
}

//function to return cell value and color 
//function formatCellValues(row,flag, type) {
//    let obj = {};
//    obj.value = "NA";
//    obj.colorClass = "";
//    obj.change = "";
//    if (row == undefined)
//        return obj;
//    if (type == "Percentage") {
//        if (row.Percentage != null) {
//            if (row.USampleSize == null) {
//                obj.value = "NA";
//            }
//            else if (row.UNumerator < insufficientSample) {
//                obj.value = "LS";
//            }
//            else {
//                if (row.UNumerator >= insufficientSample && row.UNumerator <= lowSample)
//                    obj.colorClass = 'grey';
//                if (row.ColumnMetricName.toUpperCase() == "AVERAGE ITEMS PER OCCASION" || row.RowMetricName.toUpperCase() == "AVERAGE ITEMS PER OCCASION" || row.NestingMetricName.toUpperCase() == "AVERAGE ITEMS PER OCCASION")
//                    obj.value = row.Percentage.toFixed(2);
//                else
//                    obj.value = row.Percentage.toFixed(2) + "% ";
//            }
//        }
//    }
//    else if (type == "Weighted") {
//        if (row.WSampleSize != null)
//            obj.value = Math.round(row.WNumerator);//row.WNumerator.toFixed(2);
//        if (row.UNumerator != null && row.UNumerator <= lowSample)
//            obj.colorClass = 'grey';
//    }
//    else if (type == "Unweighted") {
//        if (row.USampleSize != null)
//            obj.value = Math.round(row.UNumerator);
//        if (row.UNumerator != null && row.UNumerator <= lowSample)
//            obj.colorClass = 'grey';
//    }
//    if (obj.value != 'NA' && obj.value != "LS" && row.Significance != null && obj.colorClass != 'grey' && type == "Percentage") {
//        if (row.Significance > 0)
//            obj.colorClass = 'green';
//        else if (row.Significance < 0)
//            obj.colorClass = 'red';
//    }
//    if (type == "Percentage") {
//        if (obj.value != 'NA' && obj.value != "LS" && row.Change != null) {
//            if (row.USampleSize != "") {
//                obj.change = row.Change.toFixed(2);
//                obj.change = obj.change >= 0 ? '+' + obj.change : obj.change;
//            }
//        }
//    }
//    return obj;
//}
var scroller;
var gridRowCount = 0, sampleRowCount = 0;
function CreateGrid(type, element) {
    let gridHtml = "";
    let shadowDiv = '<div class="columnShadow"><img no-repeat="" src="../Content/Images/Kelloggs_vertical_shadow.png"></div>';
    let data = responseData;
    //let distinctColumnHeaders = angular.element(".view-container").scope().filteredColumnList.filter(function (e) { return e.toUpperCase() != "TOTAL" });
    let distinctColumnHeaders = data.filter(function (e) { return e.ColumnMetricName.toUpperCase() != "TOTAL" }).select("ColumnMetricName").distinct();
    let distinctRowHeaders = data.select("RowMetricName").distinct();
    let distinctNestingHeaders = data.filter(function (e) { return e.NestingMetricName != "" }).select("NestingMetricName").distinct();
    let colWidth = (((element.width() / document.documentElement.clientWidth) * 100 - 22) / 5) - 0.075;//6 columns including header column
    if (((distinctColumnHeaders.length + 1) * colWidth) < ((element.width() / document.documentElement.clientWidth) * 100 - 22)) {//if columns less than 6 increase column width to fit screen
        colWidth = ((element.width() / document.documentElement.clientWidth) * 100 - 22) / (distinctColumnHeaders.length + 1) - 0.075;
    }
    let addBaseClass = "";
    if (type != "Percentage")
        addBaseClass = "base";
    gridHtml += '<div class="crosstabTableDiv">' +
        '<div id="crosstabTableContent" class="crosstabTable">' +
        /*left header start*/
        '<div class="leftHeader ' + addBaseClass + '" style="width:' + (22 + colWidth) + 'vw"><div class="row-item">' +
        '<div class="row-item-div row-item-head-div"  style="width:21.9vw">' + shadowDiv + '</div>' +
        '<div class="row-item-div row-item-head-div"  style="width:' + colWidth + 'vw">' + shadowDiv +
        '<div class="row-item-head-content">TOTAL</div><div class="headerBorder"></div>' +
        '</div>' +
        '</div>';
    if (type != "Percentage") {
        let obj = {};
        if (type == "Weighted") {
            let sampleSize = data.filter(function (e) { return e.ColumnMetricName.toUpperCase() == "TOTAL" }).select("WSampleSize").distinct().sort(function (a, b) { return b - a })[0];
            if (sampleSize != null)
                obj.value = Math.round(sampleSize);//sampleSize.toFixed(2);
            else
                obj.value = "NA";
            if (data.filter(function (e) { return e.ColumnMetricName.toUpperCase() == "TOTAL" }).select("USampleSize").distinct().sort(function (a, b) { return b - a })[0] <= lowSample && obj.value != "NA")
                obj.colorClass = "grey";
        }
        else if (type == "Unweighted") {
            let sampleSize = data.filter(function (e) { return e.ColumnMetricName.toUpperCase() == "TOTAL" }).select("USampleSize").distinct().sort(function (a, b) { return b - a })[0];
            if (sampleSize != null)
                obj.value = Math.round(sampleSize);
            else
                obj.value = "NA";
            if (obj.value <= lowSample && obj.value != "NA")
                obj.colorClass = "grey";
        }
        gridHtml += '<div class="row-item"><div class="row-item-div row-item-head-div"  style="width:21.9vw">' + shadowDiv +
            '<div class="row-item-head-content"><div class="leftBorder"></div>Base</div></div>' +
            '<div class="row-item-div"  style="width:' + colWidth + 'vw">' + shadowDiv +
            '<div class="row-right-item-container">' +
            '<div class="row-right-item-content">' +
            '<div class="row-item-value row-value"><span class="percentageValue"  style="color:' + obj.colorClass + '">' + obj.value + '</span>'
        gridHtml += '</div></div></div></div></div>';
    }
    gridHtml += '</div>' /*left header left*/ +
        /*right header start*/
        '<div class="rightHeader ' + addBaseClass + '" style="width:calc(100% - ' + (22 + colWidth) + 'vw)">' +
        '<div class="row-item" style="width:' + (distinctColumnHeaders.length * colWidth) + 'vw">';
    angular.forEach(distinctColumnHeaders, function (a, b) {
        gridHtml += '<div class="row-item-div row-item-head-div" title="' + a + '" style="width:' + colWidth + 'vw">'
        if (b != distinctColumnHeaders.length - 1)
            gridHtml += shadowDiv;
        gridHtml += '<div class="row-item-head-content">' + a + '</div><div class="headerBorder"></div></div>';
    })

    gridHtml += '</div>';
    if (type != "Percentage") {//adding base row in sample size popup
        gridHtml += '<div class="row-item" style="width:' + (distinctColumnHeaders.length * colWidth) + 'vw">';
        angular.forEach(distinctColumnHeaders, function (a, b) {
            let obj = {};
            if (type == "Weighted") {
                let sampleSize = data.filter(function (e) { return e.ColumnMetricName == a }).select("WSampleSize").distinct().sort(function (a, b) { return b - a })[0];
                if (sampleSize != null)
                    obj.value = Math.round(sampleSize);//sampleSize.toFixed(2);
                else
                    obj.value = "NA";
                if (data.filter(function (e) { return e.ColumnMetricName == a }).select("USampleSize").distinct().sort(function (a, b) { return b - a })[0] <= lowSample && obj.value != "NA")
                    obj.colorClass = "grey";
            }
            else if (type == "Unweighted") {
                let sampleSize = data.filter(function (e) { return e.ColumnMetricName == a }).select("USampleSize").distinct().sort(function (a, b) { return b - a })[0];
                if (sampleSize != null)
                    obj.value = Math.round(sampleSize);
                else
                    obj.value = "NA";
                if (obj.value <= lowSample && obj.value != "NA")
                    obj.colorClass = "grey";
            }
            gridHtml += '<div class="row-item-div"  style="width:' + colWidth + 'vw">'
            if (b != distinctColumnHeaders.length - 1)
                gridHtml += shadowDiv;
            gridHtml += '<div class="row-right-item-container">' +
                '<div class="row-right-item-content">' +
                '<div class="row-item-value row-value"><span class="percentageValue"   style="color:' + obj.colorClass + '">' + obj.value + '</span>'
            gridHtml += '</div></div></div></div>';
        })

        gridHtml += '</div>'
    }
    gridHtml += '</div>'
    /*right header end*/

    /*left body start*/
    gridHtml += '<div class="leftBody ' + addBaseClass + '" style="width:' + (22 + colWidth) + 'vw">';
    //angular.forEach(distinctRowHeaders, function (a, b) {
    //    gridHtml += '<div class="row-item" style="width:100%">' +
    //                                        '<div class="row-item-div" title="' + a + '" style="width:21.9vw">' + shadowDiv +
    //                                     '<div class="row-right-item-container">' +
    //                                         '<div class="row-right-item-content"><div class="leftBorder"></div>' + a + '</div>' +
    //                                     '</div>' +
    //                                 '</div>';
    //    let obj = formatCellValues(data.filter(function (e) { return e.ColumnMetricName.toUpperCase() == "TOTAL" && e.RowMetricName == a && e.NestingMetricName == "" })[0],0, type);
    //    gridHtml += '<div class="row-item-div"  style="width:' + colWidth + 'vw">' + shadowDiv +
    //                                     '<div class="row-right-item-container">' +
    //                                         '<div class="row-right-item-content">' +
    //                                         '<div class="row-item-value row-value"><span class="percentageValue"  style="color:' + obj.colorClass + '">' + obj.value + '</span>'
    //    if (type == "Percentage" && obj.change != "") {
    //        gridHtml += '<span class="separator">|</span><span class="changeValue">' + obj.change + '</span>';
    //    }
    //    gridHtml += '</div></div></div></div></div>';
    //    /*binding nesting headers start*/
    //    if (distinctNestingHeaders.length > 0) {
    //        angular.forEach(distinctNestingHeaders, function (c, d) {
    //            gridHtml += '<div class="row-item nesting" style="width:100%">' +
    //                                                '<div class="row-item-div" title="' + c + '" style="width:21.9vw">' + shadowDiv +
    //                                             '<div class="row-right-item-container">' +
    //                                                 '<div class="row-right-item-content"><div class="leftBorder"></div>' + c + '</div>' +
    //                                             '</div>' +
    //                                         '</div>';
    //            let obj = formatCellValues(data.filter(function (e) {
    //                return e.ColumnMetricName.toUpperCase() == "TOTAL" && e.RowMetricName == a && e.NestingMetricName == c
    //            })[0],0, type);
    //            gridHtml += '<div class="row-item-div"  style="width:' + colWidth + 'vw">' + shadowDiv +
    //                                             '<div class="row-right-item-container">' +
    //                                                 '<div class="row-right-item-content">' +
    //                                                 '<div class="row-item-value row-value"><span class="percentageValue"  style="color:' + obj.colorClass + '">' + obj.value + '</span>'
    //            if (type == "Percentage" && obj.change != "") {
    //                gridHtml += '<span class="separator">|</span><span class="changeValue">' + obj.change + '</span>';
    //            }
    //            gridHtml += '</div></div></div></div></div>';
    //        })
    //    }
    //    /*binding nesting headers end*/
    //})
    gridHtml += '</div>';
    /*left body end*/

    /*right body start*/
    gridHtml += '<div class="rightBody ' + addBaseClass + '" onscroll="reposVertical(this);" onwheel="reposVertical(this);" tabindex="0" style="overflow: hidden; outline: none;width:calc(100% - ' + (22 + colWidth) + 'vw)">';
    //angular.forEach(distinctRowHeaders, function (a, b) {
    //    gridHtml += '<div class="row-item" style="width:' + (distinctColumnHeaders.length * colWidth) + 'vw">'
    //    angular.forEach(distinctColumnHeaders, function (c, d) {
    //        let obj = formatCellValues(data.filter(function (e) { return e.ColumnMetricName == c && e.RowMetricName == a && e.NestingMetricName == "" })[0],0, type);
    //        gridHtml += '<div class="row-item-div"  style="width:' + colWidth + 'vw">';
    //        if (d != distinctColumnHeaders.length - 1)
    //            gridHtml += shadowDiv;
    //        gridHtml += '<div class="row-right-item-container">' +
    //                                         '<div class="row-right-item-content">' +
    //                                             '<div class="row-item-value row-value"><span class="percentageValue" style="color:' + obj.colorClass + '">' + obj.value + '</span>'
    //        if (type == "Percentage" && obj.change != "") {
    //            gridHtml += '<span class="separator">|</span><span class="changeValue">' + obj.change + '</span>';
    //        }
    //        gridHtml += '</div>' +
    //                                         '</div>' +
    //                                     '</div>' +
    //                                 '</div>';
    //    })
    //    gridHtml += '</div>';
    //    /*binding nesting body start*/
    //    if (distinctNestingHeaders.length > 0) {
    //        angular.forEach(distinctNestingHeaders, function (a1, b1) {
    //            gridHtml += '<div class="row-item" style="width:' + (distinctColumnHeaders.length * colWidth) + 'vw">'
    //            angular.forEach(distinctColumnHeaders, function (c1, d1) {
    //                let obj = formatCellValues(data.filter(function (e) { return e.ColumnMetricName == c1 && e.RowMetricName == a && e.NestingMetricName == a1 })[0],0, type);
    //                gridHtml += '<div class="row-item-div"  style="width:' + colWidth + 'vw">';
    //                if (c1 != distinctColumnHeaders.length - 1)
    //                    gridHtml += shadowDiv;
    //                gridHtml += '<div class="row-right-item-container">' +
    //                                                 '<div class="row-right-item-content">' +
    //                                                     '<div class="row-item-value row-value"><span class="percentageValue" style="color:' + obj.colorClass + '">' + obj.value + '</span>'
    //                if (type == "Percentage" && obj.change != "") {
    //                    gridHtml += '<span class="separator">|</span><span class="changeValue">' + obj.change + '</span>';
    //                }
    //                gridHtml += '</div>' +
    //                                                 '</div>' +
    //                                             '</div>' +
    //                                         '</div>';
    //            })
    //            gridHtml += '</div>';
    //        })
    //    }
    //    /*binding nesting body end*/
    //})
    gridHtml += '</div>';
    /*right body end*/

    gridHtml += '</div>'
    gridHtml += '</div>'

    element.html(gridHtml);
    angular.element(".samplesize-popup .nicescroll-rails").remove();
    if (angular.element(document.getElementsByClassName("nsample-size_selected")).length == 0)
        angular.element("body > .nicescroll-rails").remove();
    let element1 = element.find(".crosstabTableDiv > #crosstabTableContent > .rightBody");
    SetScroll(element1, "#D31245", 0, 0, 0, 0, 3, true);
    angular.element(element1).scrollTop(0);
    angular.element(element1).scrollLeft(0);
    if (element.hasClass("chartArea"))
        gridRowCount = 0;
    else
        sampleRowCount = 0;
    initialScrollTop = 0;
    loadMore('append');
}

function loadMore(addLocation) {
    if (angular.element(document.getElementsByClassName("nsample-size_selected")).length > 0) {
        loadMoreRows(angular.element(".samplesize-popup .popup-header div.active:visible").text().trim().split(" ")[0], $(".samplesize-popup .popup-container"), addLocation);
    }
    else {
        loadMoreRows("Percentage", $(".output-container .chartArea"), addLocation)
    }
}
var currentRowHeaders = [];
function loadMoreRows(type, element, addLocation) {
    currentRowHeaders = [];
    let data = responseData;
    let shadowDiv = '<div class="columnShadow"><img no-repeat="" src="../Content/Images/Kelloggs_vertical_shadow.png"></div>';
    let distinctColumnHeaders = responseData.filter(function (e) { return e.ColumnMetricName.toUpperCase() != "TOTAL" }).select("ColumnMetricName").distinct();
    //let distinctColumnHeaders = angular.element(".view-container").scope().filteredColumnList.filter(function (e) { return e.toUpperCase() != "TOTAL" });
    let distinctRowHeaders = responseData.select("RowMetricName").distinct();
    let distinctNestingHeaders = responseData.filter(function (e) { return e.NestingMetricName != "" }).select("NestingMetricName").distinct();
    let colWidth = (((element.width() / document.documentElement.clientWidth) * 100 - 22) / 5) - 0.075;//6 columns including header column
    if (((distinctColumnHeaders.length + 1) * colWidth) < ((element.width() / document.documentElement.clientWidth) * 100 - 22)) {//if columns less than 6 increase column width to fit screen
        colWidth = ((element.width() / document.documentElement.clientWidth) * 100 - 22) / (distinctColumnHeaders.length + 1) - 0.075;
    }
    var leftGrid = '', rightGrid = "", _gridLength_CheckStatus = false;
    $(".row-item").removeClass("showItem");
    let rowCount = 0;
    for (var x = 0; x < 10 && rowCount < distinctRowHeaders.length; x++) {
        if (element.hasClass("chartArea"))
            rowCount = gridRowCount;
        else
            rowCount = sampleRowCount;
        if (rowCount < distinctRowHeaders.length) {
            let a = distinctRowHeaders[rowCount];
            distinctNestingHeaders = responseData.filter(function (e) { return e.ColumnMetricName == "TOTAL" && e.RowMetricName == a && e.NestingMetricName != "" }).select("NestingMetricName");
            currentRowHeaders.push(a);
            _gridLength_CheckStatus = true;

            /*left body*/
            leftGrid += '<div class="row-item showItem" style="width:100%">' +
                '<div class="row-item-div" title="' + a + '" style="width:21.9vw">' + shadowDiv +
                '<div class="row-right-item-container">' +
                '<div class="row-right-item-content"><div class="leftBorder"></div>' + a + '</div>' +
                '</div>' +
                '</div>';
            let obj = formatCellValues(data.filter(function (e) { return e.ColumnMetricName.toUpperCase() == "TOTAL" && e.RowMetricName == a && e.NestingMetricName == "" })[0], 0, type);
            leftGrid += '<div class="row-item-div"  style="width:' + colWidth + 'vw">' + shadowDiv +
                '<div class="row-right-item-container">' +
                '<div class="row-right-item-content">' +
                '<div class="row-item-value row-value"><span class="percentageValue"  style="color:' + obj.colorClass + '">' + obj.value + '</span>'
            if (type == "Percentage" && obj.change != "") {
                leftGrid += '<span class="separator">|</span><span class="changeValue">' + obj.change + '</span>';
            }
            leftGrid += '</div></div></div></div></div>';

            /*binding nesting headers start*/
            if (distinctNestingHeaders.length > 0) {
                angular.forEach(distinctNestingHeaders, function (c, d) {
                    let appendClass = " nesting";
                    if (c.toUpperCase().indexOf("-" + a.toUpperCase() + " BASE") > -1) {
                        appendClass = "";
                    }
                    if (!(type == "Percentage" && appendClass == "")) {
                        leftGrid += '<div class="row-item' + appendClass + '" style="width:100%">' +
                            '<div class="row-item-div" title="' + c + '" style="width:21.9vw">' + shadowDiv +
                            '<div class="row-right-item-container">' +
                            '<div class="row-right-item-content"><div class="leftBorder"></div>' + c + '</div>' +
                            '</div>' +
                            '</div>';
                        let obj = formatCellValues(data.filter(function (e) {
                            return e.ColumnMetricName.toUpperCase() == "TOTAL" && e.RowMetricName == a && e.NestingMetricName == c
                        })[0], 0, type);
                        leftGrid += '<div class="row-item-div"  style="width:' + colWidth + 'vw">' + shadowDiv +
                            '<div class="row-right-item-container">' +
                            '<div class="row-right-item-content">' +
                            '<div class="row-item-value row-value"><span class="percentageValue"  style="color:' + obj.colorClass + '">' + obj.value + '</span>'
                        if (type == "Percentage" && obj.change != "") {
                            leftGrid += '<span class="separator">|</span><span class="changeValue">' + obj.change + '</span>';
                        }
                        leftGrid += '</div></div></div></div></div>';
                    }
                })
            }
            /*binding nesting headers end*/


            /*right body*/
            rightGrid += '<div class="row-item showItem" style="width:' + (distinctColumnHeaders.length * colWidth) + 'vw">'
            angular.forEach(distinctColumnHeaders, function (c, d) {
                let obj = formatCellValues(data.filter(function (e) { return e.ColumnMetricName == c && e.RowMetricName == a && e.NestingMetricName == "" })[0], 0, type);
                rightGrid += '<div class="row-item-div"  style="width:' + colWidth + 'vw">';
                if (d != distinctColumnHeaders.length - 1)
                    rightGrid += shadowDiv;
                rightGrid += '<div class="row-right-item-container">' +
                    '<div class="row-right-item-content">' +
                    '<div class="row-item-value row-value"><span class="percentageValue" style="color:' + obj.colorClass + '">' + obj.value + '</span>'
                if (type == "Percentage" && obj.change != "") {
                    rightGrid += '<span class="separator">|</span><span class="changeValue">' + obj.change + '</span>';
                }
                rightGrid += '</div>' +
                    '</div>' +
                    '</div>' +
                    '</div>';
            })
            rightGrid += '</div>';
            /*binding nesting body start*/
            if (distinctNestingHeaders.length > 0) {
                angular.forEach(distinctNestingHeaders, function (a1, b1) {
                    let appendClass = " nesting";
                    if (a1.toUpperCase().indexOf("-" + a.toUpperCase() + " BASE") > -1) {
                        appendClass = "";
                    }
                    if (!(type == "Percentage" && appendClass == "")) {
                        rightGrid += '<div class="row-item' + appendClass + '" style="width:' + (distinctColumnHeaders.length * colWidth) + 'vw">'
                        angular.forEach(distinctColumnHeaders, function (c1, d1) {
                            let obj = formatCellValues(data.filter(function (e) { return e.ColumnMetricName == c1 && e.RowMetricName == a && e.NestingMetricName == a1 })[0], 0, type);
                            rightGrid += '<div class="row-item-div"  style="width:' + colWidth + 'vw">';
                            if (c1 != distinctColumnHeaders.length - 1)
                                rightGrid += shadowDiv;
                            rightGrid += '<div class="row-right-item-container">' +
                                '<div class="row-right-item-content">' +
                                '<div class="row-item-value row-value"><span class="percentageValue" style="color:' + obj.colorClass + '">' + obj.value + '</span>'
                            if (type == "Percentage" && obj.change != "") {
                                rightGrid += '<span class="separator">|</span><span class="changeValue">' + obj.change + '</span>';
                            }
                            rightGrid += '</div>' +
                                '</div>' +
                                '</div>' +
                                '</div>';
                        })

                        rightGrid += '</div>';
                    }
                })
            }
            /*binding nesting body end*/
            if (element.hasClass("chartArea"))
                gridRowCount = gridRowCount + 1;
            else
                sampleRowCount = sampleRowCount + 1;
        }
    }
    if (_gridLength_CheckStatus) {
        //if (addLocation == "append") {
        element.find(".leftBody").append(leftGrid);
        element.find(".rightBody").append(rightGrid);
        //}
        //else {
        //    angular.element(document.getElementsByClassName("leftBody")).prepend(leftGrid);
        //    angular.element(document.getElementsByClassName("rightBody")).prepend(rightGrid);
        //}
        //$(".leftBody .row-item:not(.showItem)").remove();
        //$(".rightBody .row-item:not(.showItem)").remove();
    }
}